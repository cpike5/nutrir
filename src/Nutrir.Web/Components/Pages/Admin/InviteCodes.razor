@page "/admin/invite-codes"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Nutrir.Core.DTOs
@using Nutrir.Core.Interfaces
@using Nutrir.Web.Components.UI
@using System.Security.Claims
@attribute [Authorize(Roles = "Admin,Nutritionist")]
@inject IInviteCodeService InviteCodeService
@inject AuthenticationStateProvider AuthState
@inject IJSRuntime JS

<PageTitle>Invite Codes — Nutrir</PageTitle>

<Breadcrumb Items="@(new[] { new BreadcrumbItem("Admin"), new BreadcrumbItem("Invite Codes") })" />

<div class="invite-page">
    <div class="page-header">
        <h1 class="page-title">Invite Codes</h1>
        <span class="page-subtitle">Generate and manage invite codes for staff registration.</span>
    </div>

    <!-- Generate Section -->
    <div class="table-card section-animate">
        <div class="section-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
            </svg>
            <span class="section-header-label">Generate Code</span>
        </div>
        <div class="generate-body">
            <div class="generate-fields">
                <div class="field-group">
                    <label class="field-label" for="target-role">Target Role</label>
                    <select id="target-role" class="field-select" @bind="_targetRole">
                        <option value="Nutritionist">Nutritionist</option>
                        <option value="Assistant">Assistant</option>
                    </select>
                </div>
                <div class="field-group">
                    <label class="field-label" for="expiration-days">Expires In (days)</label>
                    <input id="expiration-days" type="number" class="field-input" @bind="_expirationDays" min="1" />
                </div>
                <div class="field-action">
                    <Button Variant="ButtonVariant.Primary"
                            Disabled="@_isGenerating"
                            OnClick="GenerateCode">
                        @if (_isGenerating)
                        {
                            <span>Generating...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: -2px;">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            <span>Generate</span>
                        }
                    </Button>
                </div>
            </div>

            @if (_generatedCode is not null)
            {
                <div class="code-result">
                    <div class="code-result-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        <span>Code Generated</span>
                    </div>
                    <div class="code-display">
                        <span class="code-value">@_generatedCode.Code</span>
                        <button class="copy-btn" @onclick="CopyCodeToClipboard" title="Copy to clipboard">
                            @if (_copied)
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Copied</span>
                            }
                            else
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                <span>Copy</span>
                            }
                        </button>
                    </div>
                    <span class="code-meta">
                        <Badge Variant="BadgeVariant.Primary">@_generatedCode.TargetRole</Badge>
                        <span class="meta-sep">·</span>
                        Expires @_generatedCode.ExpiresAt.ToString("MMM d, yyyy")
                    </span>
                </div>
            }

            @if (_generateError is not null)
            {
                <div class="error-banner">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                    @_generateError
                </div>
            }
        </div>
    </div>

    <!-- Codes Table -->
    <div class="table-card section-animate" style="animation-delay: 0.08s;">
        <div class="section-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <span class="section-header-label">All Codes</span>
            @if (_inviteCodes is not null && _inviteCodes.Count > 0)
            {
                <span class="codes-count">
                    <span class="badge-dot"></span>
                    @_inviteCodes.Count code@(_inviteCodes.Count != 1 ? "s" : "")
                </span>
            }
        </div>

        @if (_isLoading)
        {
            <p class="codes-loading">Loading invite codes...</p>
        }
        else if (_inviteCodes is null || _inviteCodes.Count == 0)
        {
            <div class="empty-state">
                <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                </svg>
                <p class="empty-state-title">No invite codes yet</p>
                <p class="empty-state-desc">Generate your first invite code above to allow staff to register.</p>
            </div>
        }
        else
        {
            <table class="codes-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th class="col-created-by">Created By</th>
                        <th class="col-created">Created</th>
                        <th class="col-redeemed">Redeemed By</th>
                        <th>Expires</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in _inviteCodes)
                    {
                        var status = GetStatus(item);
                        <tr>
                            <td class="cell-code">@item.Code</td>
                            <td><Badge Variant="BadgeVariant.Primary">@item.TargetRole</Badge></td>
                            <td><Badge Variant="@status.Variant">@status.Label</Badge></td>
                            <td class="col-created-by">@item.CreatedByName</td>
                            <td class="cell-muted col-created">@item.CreatedAt.ToString("MMM d, yyyy")</td>
                            <td class="col-redeemed">@(item.RedeemedByName ?? "—")</td>
                            <td class="cell-muted">@item.ExpiresAt.ToString("MMM d, yyyy")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@code {
    private List<InviteCodeListItemDto>? _inviteCodes;
    private InviteCodeListItemDto? _generatedCode;
    private string _targetRole = "Nutritionist";
    private string _expirationDays = "7";
    private bool _isLoading = true;
    private bool _isGenerating;
    private bool _copied;
    private string? _generateError;

    protected override async Task OnInitializedAsync()
    {
        await LoadCodesAsync();
    }

    private async Task LoadCodesAsync()
    {
        _isLoading = true;
        _inviteCodes = await InviteCodeService.GetAllAsync();
        _isLoading = false;
    }

    private async Task GenerateCode()
    {
        _isGenerating = true;
        _generateError = null;
        _generatedCode = null;
        _copied = false;

        try
        {
            var authState = await AuthState.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                _generateError = "Unable to determine current user.";
                return;
            }

            if (!int.TryParse(_expirationDays, out var days) || days < 1)
            {
                _generateError = "Expiration days must be a positive number.";
                return;
            }

            _generatedCode = await InviteCodeService.GenerateAsync(userId, _targetRole, days);
            await LoadCodesAsync();
        }
        catch (Exception)
        {
            _generateError = "An error occurred while generating the invite code.";
        }
        finally
        {
            _isGenerating = false;
        }
    }

    private async Task CopyCodeToClipboard()
    {
        if (_generatedCode is not null)
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _generatedCode.Code);
            _copied = true;
        }
    }

    private static (string Label, BadgeVariant Variant) GetStatus(InviteCodeListItemDto code)
    {
        if (code.IsUsed)
            return ("Used", BadgeVariant.Secondary);
        if (code.ExpiresAt < DateTime.UtcNow)
            return ("Expired", BadgeVariant.Warning);
        return ("Active", BadgeVariant.Success);
    }
}
