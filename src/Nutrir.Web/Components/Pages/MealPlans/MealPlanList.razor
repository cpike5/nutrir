@page "/meal-plans"
@rendermode InteractiveServer
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Authorization
@using Nutrir.Core.DTOs
@using Nutrir.Core.Enums
@using Nutrir.Core.Interfaces
@using Nutrir.Web.Services
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IMealPlanService MealPlanService
@inject NavigationManager NavigationManager
@inject RealTimeNotificationService NotificationService

<PageTitle>Meal Plans — Nutrir</PageTitle>

<Breadcrumb Items="@(new[] { new BreadcrumbItem("Meal Plans") })" />

<div class="mp-list-page">
    <div class="page-header">
        <h1 class="page-title">Meal Plans</h1>
        <Button Variant="ButtonVariant.Primary" OnClick="NavigateToCreate">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: -2px;">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            New Meal Plan
        </Button>
    </div>

    <DataGrid TItem="MealPlanSummaryDto"
              Items="@_result?.Items"
              TotalCount="@(_result?.TotalCount ?? 0)"
              Page="@_query.Page"
              PageSize="@_query.PageSize"
              SortColumn="@_query.SortColumn"
              SortDirection="@_query.SortDirection"
              OnQueryChanged="HandleQueryChanged"
              IsLoading="@_isLoading"
              ShowRealtimeBanner="@_refreshedByRealTime">
        <ToolbarContent>
            <div class="filter-group">
                <span class="filter-label">Status</span>
                <select class="filter-select" @onchange="OnStatusChanged">
                    <option value="">All Statuses</option>
                    <option value="Draft" selected="@(_query.StatusFilter == MealPlanStatus.Draft)">Draft</option>
                    <option value="Active" selected="@(_query.StatusFilter == MealPlanStatus.Active)">Active</option>
                    <option value="Archived" selected="@(_query.StatusFilter == MealPlanStatus.Archived)">Archived</option>
                </select>
            </div>
            @if (_result is not null && _result.TotalCount > 0)
            {
                <span class="mp-count">@_result.TotalCount plan@(_result.TotalCount != 1 ? "s" : "")</span>
            }
        </ToolbarContent>
        <Columns>
            <DataGridColumn TItem="MealPlanSummaryDto" Key="title" Header="Title" Sortable>
                <CellTemplate Context="plan">
                    <span class="cell-title">@plan.Title</span>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="MealPlanSummaryDto" Key="client" Header="Client" Sortable>
                <CellTemplate Context="plan">
                    @plan.ClientFirstName @plan.ClientLastName
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="MealPlanSummaryDto" Key="status" Header="Status" Sortable>
                <CellTemplate Context="plan">
                    <Badge Variant="@GetStatusVariant(plan.Status)">@plan.Status</Badge>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="MealPlanSummaryDto" Key="days" Header="Days" HideBelow="hide-below-860">
                <CellTemplate Context="plan">
                    <span class="cell-muted">@plan.DayCount</span>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="MealPlanSummaryDto" Key="startdate" Header="Start Date" HideBelow="hide-below-860">
                <CellTemplate Context="plan">
                    <span class="cell-muted">@(plan.StartDate?.ToString("MMM d, yyyy") ?? "—")</span>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="MealPlanSummaryDto" Key="created" Header="Created" Sortable HideBelow="hide-below-860">
                <CellTemplate Context="plan">
                    <span class="cell-muted">@plan.CreatedAt.ToString("MMM d")</span>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="MealPlanSummaryDto" Key="actions" Header="Actions">
                <CellTemplate Context="plan">
                    <div class="row-actions">
                        <a href="meal-plans/@plan.Id" class="btn-icon" title="View">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <span class="sr-only">View</span>
                        </a>
                        @if (plan.Status is MealPlanStatus.Draft or MealPlanStatus.Active)
                        {
                            <a href="meal-plans/@plan.Id/edit-details" class="btn-icon" title="Edit Details">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                                <span class="sr-only">Edit Details</span>
                            </a>
                            <a href="meal-plans/@plan.Id/edit" class="btn-icon" title="Edit Meals">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                                <span class="sr-only">Edit Meals</span>
                            </a>
                        }
                    </div>
                </CellTemplate>
            </DataGridColumn>
        </Columns>
        <EmptyContent>
            <div class="empty-state">
                <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" />
                    <path d="M7 2v20" />
                    <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />
                </svg>
                <p class="empty-state-title">No meal plans found</p>
                <p class="empty-state-desc">
                    @if (_query.StatusFilter is null)
                    {
                        <span>Create your first meal plan to get started.</span>
                    }
                    else
                    {
                        <span>Try adjusting your filters.</span>
                    }
                </p>
            </div>
        </EmptyContent>
    </DataGrid>
</div>

@code {
    [SupplyParameterFromQuery] public int? ClientId { get; set; }

    private PagedResult<MealPlanSummaryDto>? _result;
    private MealPlanListQuery _query = new();
    private bool _isLoading = true;
    private bool _refreshedByRealTime;
    private System.Threading.Timer? _notificationDebounceTimer;

    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnEntityChanged += OnEntityChanged;
        await NotificationService.StartAsync();
        _query = _query with { ClientId = ClientId };
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _refreshedByRealTime = false;
        _isLoading = true;
        _result = await MealPlanService.GetPagedAsync(_query);
        _isLoading = false;
    }

    private async Task HandleQueryChanged(GridQuery gridQuery)
    {
        _query = _query with
        {
            Page = gridQuery.Page,
            PageSize = gridQuery.PageSize,
            SortColumn = gridQuery.SortColumn,
            SortDirection = gridQuery.SortDirection
        };
        await LoadDataAsync();
    }

    private async Task OnStatusChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        MealPlanStatus? status = null;
        if (!string.IsNullOrEmpty(value) && Enum.TryParse<MealPlanStatus>(value, out var parsed))
            status = parsed;
        _query = _query with { StatusFilter = status, Page = 1 };
        await LoadDataAsync();
    }

    private void NavigateToCreate()
    {
        var url = ClientId.HasValue ? $"/meal-plans/new?clientId={ClientId}" : "/meal-plans/new";
        NavigationManager.NavigateTo(url);
    }

    private void OnEntityChanged(EntityChangeNotification notification)
    {
        if (notification.EntityType != "MealPlan")
            return;

        _notificationDebounceTimer?.Dispose();
        _notificationDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadDataAsync();
                _refreshedByRealTime = true;
                StateHasChanged();
            });
        }, null, 1500, Timeout.Infinite);
    }

    public ValueTask DisposeAsync()
    {
        NotificationService.OnEntityChanged -= OnEntityChanged;
        _notificationDebounceTimer?.Dispose();
        return ValueTask.CompletedTask;
    }

    private static BadgeVariant GetStatusVariant(MealPlanStatus status) => status switch
    {
        MealPlanStatus.Draft => BadgeVariant.Secondary,
        MealPlanStatus.Active => BadgeVariant.Success,
        MealPlanStatus.Archived => BadgeVariant.Accent,
        _ => BadgeVariant.Primary
    };
}
