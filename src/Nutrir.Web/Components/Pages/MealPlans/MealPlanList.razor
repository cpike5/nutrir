@page "/meal-plans"
@rendermode InteractiveServer
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Authorization
@using Nutrir.Core.DTOs
@using Nutrir.Core.Enums
@using Nutrir.Core.Interfaces
@using Nutrir.Web.Services
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IMealPlanService MealPlanService
@inject NavigationManager NavigationManager
@inject RealTimeNotificationService NotificationService

<PageTitle>Meal Plans — Nutrir</PageTitle>

<Breadcrumb Items="@(new[] { new BreadcrumbItem("Meal Plans") })" />

<div class="mp-list-page">
    <div class="page-header">
        <h1 class="page-title">Meal Plans</h1>
        <Button Variant="ButtonVariant.Primary" OnClick="NavigateToCreate">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: -2px;">
                <path d="M12 5v14M5 12h14"/>
            </svg>
            New Meal Plan
        </Button>
    </div>

    <div class="toolbar">
        <div class="filter-group">
            <span class="filter-label">Status</span>
            <select class="filter-select" @onchange="OnStatusChanged">
                <option value="">All Statuses</option>
                <option value="Draft" selected="@(_statusFilter == "Draft")">Draft</option>
                <option value="Active" selected="@(_statusFilter == "Active")">Active</option>
                <option value="Archived" selected="@(_statusFilter == "Archived")">Archived</option>
            </select>
        </div>
        @if (_mealPlans is not null && _mealPlans.Count > 0)
        {
            <span class="mp-count">
                <span class="badge-dot" style="background: var(--color-primary);"></span>
                @_mealPlans.Count plan@(_mealPlans.Count != 1 ? "s" : "")
            </span>
        }
    </div>

    <div class="table-card">
        @if (_isLoading)
        {
            <p class="mp-loading">Loading meal plans...</p>
        }
        else if (_mealPlans is null || _mealPlans.Count == 0)
        {
            <div class="empty-state">
                <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" />
                    <path d="M7 2v20" />
                    <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />
                </svg>
                <p class="empty-state-title">No meal plans found</p>
                <p class="empty-state-desc">
                    @if (string.IsNullOrEmpty(_statusFilter))
                    {
                        <span>Create your first meal plan to get started.</span>
                    }
                    else
                    {
                        <span>Try adjusting your filters.</span>
                    }
                </p>
            </div>
        }
        else
        {
            @if (_refreshedByRealTime)
            {
                <div class="realtime-banner" role="status" aria-live="polite">
                    <span class="realtime-dot"></span>
                    Updated in real time
                </div>
            }
            <table class="mp-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Client</th>
                        <th>Status</th>
                        <th class="col-days">Days</th>
                        <th class="col-start-date">Start Date</th>
                        <th class="col-created">Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var plan in _mealPlans)
                    {
                        <tr>
                            <td class="cell-title">@plan.Title</td>
                            <td>@plan.ClientFirstName @plan.ClientLastName</td>
                            <td><Badge Variant="@GetStatusVariant(plan.Status)">@plan.Status</Badge></td>
                            <td class="cell-muted col-days">@plan.DayCount</td>
                            <td class="cell-muted col-start-date">@(plan.StartDate?.ToString("MMM d, yyyy") ?? "—")</td>
                            <td class="cell-muted col-created">@plan.CreatedAt.ToString("MMM d")</td>
                            <td>
                                <div class="row-actions">
                                    <a href="meal-plans/@plan.Id" class="btn-icon" title="View">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                        <span class="sr-only">View</span>
                                    </a>
                                    @if (plan.Status is MealPlanStatus.Draft or MealPlanStatus.Active)
                                    {
                                        <a href="meal-plans/@plan.Id/edit-details" class="btn-icon" title="Edit Details">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                                            <span class="sr-only">Edit Details</span>
                                        </a>
                                        <a href="meal-plans/@plan.Id/edit" class="btn-icon" title="Edit Meals">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                                            <span class="sr-only">Edit Meals</span>
                                        </a>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public int? ClientId { get; set; }

    private List<MealPlanSummaryDto>? _mealPlans;
    private string? _statusFilter;
    private bool _isLoading = true;
    private bool _refreshedByRealTime;
    private System.Threading.Timer? _notificationDebounceTimer;

    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnEntityChanged += OnEntityChanged;
        await NotificationService.StartAsync();
        await LoadMealPlansAsync();
    }

    private async Task LoadMealPlansAsync()
    {
        _refreshedByRealTime = false;
        _isLoading = true;

        MealPlanStatus? status = null;
        if (!string.IsNullOrEmpty(_statusFilter) && Enum.TryParse<MealPlanStatus>(_statusFilter, out var parsed))
            status = parsed;

        _mealPlans = await MealPlanService.GetListAsync(ClientId, status);
        _isLoading = false;
    }

    private async Task OnStatusChanged(ChangeEventArgs e)
    {
        _statusFilter = e.Value?.ToString();
        await LoadMealPlansAsync();
    }

    private void NavigateToCreate()
    {
        var url = ClientId.HasValue ? $"/meal-plans/new?clientId={ClientId}" : "/meal-plans/new";
        NavigationManager.NavigateTo(url);
    }

    private void OnEntityChanged(EntityChangeNotification notification)
    {
        if (notification.EntityType != "MealPlan")
            return;

        _notificationDebounceTimer?.Dispose();
        _notificationDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadMealPlansAsync();
                _refreshedByRealTime = true;
                StateHasChanged();
            });
        }, null, 1500, Timeout.Infinite);
    }

    public ValueTask DisposeAsync()
    {
        NotificationService.OnEntityChanged -= OnEntityChanged;
        _notificationDebounceTimer?.Dispose();
        return ValueTask.CompletedTask;
    }

    private static BadgeVariant GetStatusVariant(MealPlanStatus status) => status switch
    {
        MealPlanStatus.Draft => BadgeVariant.Secondary,
        MealPlanStatus.Active => BadgeVariant.Success,
        MealPlanStatus.Archived => BadgeVariant.Accent,
        _ => BadgeVariant.Primary
    };
}
