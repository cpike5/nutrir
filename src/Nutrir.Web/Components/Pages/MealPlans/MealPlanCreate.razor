@page "/meal-plans/new"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Nutrir.Core.DTOs
@using Nutrir.Core.Interfaces
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IMealPlanService MealPlanService
@inject IClientService ClientService
@inject NavigationManager NavigationManager

<PageTitle>New Meal Plan — Nutrir</PageTitle>

<div class="client-form-page">
    <div class="client-form-header">
        <h1 class="client-form-title">New Meal Plan</h1>
    </div>

    <Card>
        <div class="client-form-body">
            <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="CreateMealPlan">
                <DataAnnotationsValidator />

                <FormGroup Label="Client" Id="clientId" Error="@GetFieldError(nameof(_model.ClientId))">
                    <FormSelect Id="clientId"
                                Value="@_model.ClientId"
                                ValueChanged="@(v => _model.ClientId = v)">
                        <option value="">Select a client...</option>
                        @foreach (var client in _clients)
                        {
                            <option value="@client.Id">@client.FirstName @client.LastName</option>
                        }
                    </FormSelect>
                </FormGroup>

                <FormGroup Label="Title" Id="title" Error="@GetFieldError(nameof(_model.Title))">
                    <FormInput Id="title"
                               Value="@_model.Title"
                               ValueChanged="@(v => _model.Title = v)"
                               Placeholder="e.g. Week 1 — Weight Loss" />
                </FormGroup>

                <FormGroup Label="Description" Id="description">
                    <textarea id="description"
                              class="form-input"
                              rows="2"
                              @bind="_model.Description"
                              placeholder="Overview or goals..."></textarea>
                </FormGroup>

                <div class="client-form-grid">
                    <FormGroup Label="Start Date" Id="startDate">
                        <FormInput Id="startDate" Type="date"
                                   Value="@_model.StartDate"
                                   ValueChanged="@(v => _model.StartDate = v)" />
                    </FormGroup>

                    <FormGroup Label="End Date" Id="endDate">
                        <FormInput Id="endDate" Type="date"
                                   Value="@_model.EndDate"
                                   ValueChanged="@(v => _model.EndDate = v)" />
                    </FormGroup>
                </div>

                <FormGroup Label="Number of Days" Id="days">
                    <FormSelect Id="days"
                                Value="@_model.NumberOfDays"
                                ValueChanged="@(v => _model.NumberOfDays = v)">
                        @for (var i = 1; i <= 7; i++)
                        {
                            <option value="@i">@i @(i == 1 ? "day" : "days")</option>
                        }
                    </FormSelect>
                </FormGroup>

                <div class="client-form-grid">
                    <FormGroup Label="Calorie Target (kcal)" Id="calories">
                        <FormInput Id="calories" Type="number"
                                   Value="@_model.CalorieTarget"
                                   ValueChanged="@(v => _model.CalorieTarget = v)"
                                   Placeholder="e.g. 2000" />
                    </FormGroup>
                    <FormGroup Label="Protein Target (g)" Id="protein">
                        <FormInput Id="protein" Type="number"
                                   Value="@_model.ProteinTarget"
                                   ValueChanged="@(v => _model.ProteinTarget = v)"
                                   Placeholder="e.g. 150" />
                    </FormGroup>
                </div>

                <div class="client-form-grid">
                    <FormGroup Label="Carbs Target (g)" Id="carbs">
                        <FormInput Id="carbs" Type="number"
                                   Value="@_model.CarbsTarget"
                                   ValueChanged="@(v => _model.CarbsTarget = v)"
                                   Placeholder="e.g. 200" />
                    </FormGroup>
                    <FormGroup Label="Fat Target (g)" Id="fat">
                        <FormInput Id="fat" Type="number"
                                   Value="@_model.FatTarget"
                                   ValueChanged="@(v => _model.FatTarget = v)"
                                   Placeholder="e.g. 67" />
                    </FormGroup>
                </div>

                <FormGroup Label="Internal Notes" Id="notes">
                    <textarea id="notes"
                              class="form-input"
                              rows="2"
                              @bind="_model.Notes"
                              placeholder="Practitioner notes..."></textarea>
                </FormGroup>

                <FormGroup Label="Client Instructions" Id="instructions">
                    <textarea id="instructions"
                              class="form-input"
                              rows="2"
                              @bind="_model.Instructions"
                              placeholder="Instructions for the client..."></textarea>
                </FormGroup>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <p class="client-form-error">@_errorMessage</p>
                }

                <div class="client-form-actions">
                    <Button Variant="ButtonVariant.Primary" Type="submit" Disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <span>Creating...</span>
                        }
                        else
                        {
                            <span>Create Meal Plan</span>
                        }
                    </Button>
                    <a href="/meal-plans" class="client-form-cancel-link">Cancel</a>
                </div>
            </EditForm>
        </div>
    </Card>
</div>

@code {
    [SupplyParameterFromQuery] public int? ClientId { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;

    private MealPlanFormModel _model = new();
    private EditContext? _editContext;
    private List<ClientDto> _clients = [];
    private bool _isSubmitting;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_model);
        _clients = await ClientService.GetListAsync();

        if (ClientId.HasValue)
        {
            _model.ClientId = ClientId.Value.ToString();
        }
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            if (string.IsNullOrEmpty(_model.ClientId) || !int.TryParse(_model.ClientId, out var clientId))
            {
                _errorMessage = "Please select a client.";
                return;
            }

            if (string.IsNullOrWhiteSpace(_model.Title))
            {
                _errorMessage = "Title is required.";
                return;
            }

            if (!int.TryParse(_model.NumberOfDays, out var numberOfDays))
                numberOfDays = 7;

            DateOnly? startDate = null;
            if (!string.IsNullOrEmpty(_model.StartDate) && DateOnly.TryParse(_model.StartDate, out var sd))
                startDate = sd;

            DateOnly? endDate = null;
            if (!string.IsNullOrEmpty(_model.EndDate) && DateOnly.TryParse(_model.EndDate, out var ed))
                endDate = ed;

            decimal? calorieTarget = null;
            if (!string.IsNullOrEmpty(_model.CalorieTarget) && decimal.TryParse(_model.CalorieTarget, out var ct))
                calorieTarget = ct;

            decimal? proteinTarget = null;
            if (!string.IsNullOrEmpty(_model.ProteinTarget) && decimal.TryParse(_model.ProteinTarget, out var pt))
                proteinTarget = pt;

            decimal? carbsTarget = null;
            if (!string.IsNullOrEmpty(_model.CarbsTarget) && decimal.TryParse(_model.CarbsTarget, out var cbt))
                carbsTarget = cbt;

            decimal? fatTarget = null;
            if (!string.IsNullOrEmpty(_model.FatTarget) && decimal.TryParse(_model.FatTarget, out var ft))
                fatTarget = ft;

            var authState = await AuthState;
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

            var dto = new CreateMealPlanDto(
                ClientId: clientId,
                Title: _model.Title!,
                Description: string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description,
                StartDate: startDate,
                EndDate: endDate,
                CalorieTarget: calorieTarget,
                ProteinTargetG: proteinTarget,
                CarbsTargetG: carbsTarget,
                FatTargetG: fatTarget,
                Notes: string.IsNullOrWhiteSpace(_model.Notes) ? null : _model.Notes,
                Instructions: string.IsNullOrWhiteSpace(_model.Instructions) ? null : _model.Instructions,
                NumberOfDays: numberOfDays);

            var created = await MealPlanService.CreateAsync(dto, userId);
            NavigationManager.NavigateTo($"/meal-plans/{created.Id}/edit");
        }
        catch
        {
            _errorMessage = "An error occurred while creating the meal plan. Please try again.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string? GetFieldError(string fieldName)
    {
        if (_editContext is null) return null;
        var messages = _editContext.GetValidationMessages(new FieldIdentifier(_model, fieldName));
        return messages.FirstOrDefault();
    }

    private class MealPlanFormModel
    {
        [Required(ErrorMessage = "Client is required.")]
        public string? ClientId { get; set; }

        [Required(ErrorMessage = "Title is required.")]
        public string? Title { get; set; }

        public string? Description { get; set; }
        public string? StartDate { get; set; }
        public string? EndDate { get; set; }
        public string NumberOfDays { get; set; } = "7";
        public string? CalorieTarget { get; set; }
        public string? ProteinTarget { get; set; }
        public string? CarbsTarget { get; set; }
        public string? FatTarget { get; set; }
        public string? Notes { get; set; }
        public string? Instructions { get; set; }
    }
}
