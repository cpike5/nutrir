@page "/meal-plans/{Id:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Nutrir.Core.DTOs
@using Nutrir.Core.Enums
@using Nutrir.Core.Interfaces
@using Nutrir.Web.Components.UI
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IMealPlanService MealPlanService
@inject IAuditLogService AuditLogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<PageTitle>@(_plan is not null ? _plan.Title : "Meal Plan") — Nutrir</PageTitle>

<Breadcrumb Items="@(new[] { new BreadcrumbItem("Meal Plans", "/meal-plans"), new BreadcrumbItem(_plan?.Title ?? "Meal Plan") })" />

<div class="mp-detail-page">
    @if (_isLoading)
    {
        <p class="mp-loading">Loading meal plan...</p>
    }
    else if (_plan is null)
    {
        <div class="table-card">
            <div class="mp-not-found">
                <p class="not-found-title">Meal plan not found</p>
                <div class="not-found-action">
                    <Button Variant="ButtonVariant.Outline" OnClick="@(() => NavigationManager.NavigateTo("/meal-plans"))">Back to Meal Plans</Button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Hero Card -->
        <div class="table-card section-animate">
            <div class="hero">
                <div class="hero-identity">
                    <div class="hero-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" />
                            <path d="M7 2v20" />
                            <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />
                        </svg>
                    </div>
                    <div class="hero-info">
                        <div class="hero-title-row">
                            <h1 class="hero-name">@_plan.Title</h1>
                            <Badge Variant="@GetStatusVariant(_plan.Status)">@_plan.Status</Badge>
                        </div>
                        <div class="hero-meta-rows">
                            <div class="hero-meta-row">
                                <span class="meta-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                                    <a href="/clients/@_plan.ClientId" class="client-link">@_plan.ClientFirstName @_plan.ClientLastName</a>
                                </span>
                                @if (_plan.StartDate.HasValue || _plan.EndDate.HasValue)
                                {
                                    <span class="meta-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                                        @(_plan.StartDate?.ToString("MMM d, yyyy") ?? "—") to @(_plan.EndDate?.ToString("MMM d, yyyy") ?? "—")
                                    </span>
                                }
                            </div>
                            @if (_plan.CalorieTarget.HasValue || _plan.ProteinTargetG.HasValue)
                            {
                                <div class="hero-meta-row">
                                    <span class="meta-item">
                                        <div class="macro-bar">
                                            @if (_plan.CalorieTarget.HasValue) { <span>@_plan.CalorieTarget.Value.ToString("N0") kcal</span> }
                                            @if (_plan.ProteinTargetG.HasValue) { <span>@_plan.ProteinTargetG.Value.ToString("N0")g P</span> }
                                            @if (_plan.CarbsTargetG.HasValue) { <span>@_plan.CarbsTargetG.Value.ToString("N0")g C</span> }
                                            @if (_plan.FatTargetG.HasValue) { <span>@_plan.FatTargetG.Value.ToString("N0")g F</span> }
                                        </div>
                                    </span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="hero-actions">
                    @if (_plan.Status is MealPlanStatus.Draft)
                    {
                        <Button Variant="ButtonVariant.Primary" OnClick="NavigateToEditDetails">Edit Details</Button>
                        <Button Variant="ButtonVariant.Outline" OnClick="NavigateToEdit">Edit Meals</Button>
                        <Button Variant="ButtonVariant.Outline" OnClick="ActivatePlan">Activate</Button>
                        <Button Variant="ButtonVariant.Ghost" OnClick="@(() => _showDeleteConfirm = true)">Delete</Button>
                    }
                    else if (_plan.Status is MealPlanStatus.Active)
                    {
                        <Button Variant="ButtonVariant.Primary" OnClick="NavigateToEditDetails">Edit Details</Button>
                        <Button Variant="ButtonVariant.Outline" OnClick="NavigateToEdit">Edit Meals</Button>
                        <Button Variant="ButtonVariant.Outline" OnClick="DuplicatePlan">Duplicate</Button>
                        <Button Variant="ButtonVariant.Ghost" OnClick="ArchivePlan">Archive</Button>
                    }
                    else if (_plan.Status is MealPlanStatus.Archived)
                    {
                        <Button Variant="ButtonVariant.Outline" OnClick="DuplicatePlan">Duplicate</Button>
                        <Button Variant="ButtonVariant.Ghost" OnClick="ReactivatePlan">Reactivate</Button>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_plan.CreatedByName))
            {
                <div class="section-header">
                    <span class="section-header-label">Details</span>
                </div>
                <div class="detail-grid">
                    <div class="detail-field">
                        <span class="detail-label">Created By</span>
                        <span class="detail-value">@_plan.CreatedByName</span>
                    </div>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(_plan.Description))
        {
            <div class="table-card section-animate" style="animation-delay: 0.08s;">
                <div class="section-header">
                    <span class="section-header-label">Description</span>
                </div>
                <div class="notes-body">
                    <pre class="notes-text">@_plan.Description</pre>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(_plan.Instructions))
        {
            <div class="table-card section-animate" style="animation-delay: 0.12s;">
                <div class="section-header">
                    <span class="section-header-label">Client Instructions</span>
                </div>
                <div class="notes-body">
                    <pre class="notes-text">@_plan.Instructions</pre>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(_plan.Notes))
        {
            <div class="table-card section-animate" style="animation-delay: 0.16s;">
                <div class="section-header">
                    <span class="section-header-label">Internal Notes</span>
                </div>
                <div class="notes-body">
                    <pre class="notes-text">@_plan.Notes</pre>
                </div>
            </div>
        }

        <!-- Days / Meals / Items Hierarchy -->
        @foreach (var day in _plan.Days)
        {
            <Panel Title="@(day.Label ?? $"Day {day.DayNumber}")" Count="@(day.MealSlots.Count > 0 ? day.MealSlots.Count : null)">
                <HeaderExtra>
                    <span class="day-totals-header">
                        @day.TotalCalories.ToString("N0") kcal · @day.TotalProtein.ToString("N0")g P · @day.TotalCarbs.ToString("N0")g C · @day.TotalFat.ToString("N0")g F
                    </span>
                </HeaderExtra>
                <ChildContent>
                    @if (day.MealSlots.Count == 0)
                    {
                        <div class="cc-empty-state">
                            <p>No meals added for this day</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var slot in day.MealSlots)
                        {
                            <div class="slot-section">
                                <div class="slot-header">
                                    <span class="slot-name">@(slot.CustomName ?? FormatMealType(slot.MealType))</span>
                                    <span class="slot-totals">
                                        @slot.TotalCalories.ToString("N0") kcal · @slot.TotalProtein.ToString("N0")g P · @slot.TotalCarbs.ToString("N0")g C · @slot.TotalFat.ToString("N0")g F
                                    </span>
                                </div>
                                @if (slot.Items.Count > 0)
                                {
                                    <table class="items-table">
                                        <thead>
                                            <tr>
                                                <th>Food</th>
                                                <th>Qty</th>
                                                <th>Cal</th>
                                                <th>P</th>
                                                <th>C</th>
                                                <th>F</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in slot.Items)
                                            {
                                                <tr>
                                                    <td class="item-name">
                                                        @item.FoodName
                                                        @if (!string.IsNullOrEmpty(item.Notes))
                                                        {
                                                            <span class="item-note">@item.Notes</span>
                                                        }
                                                    </td>
                                                    <td>@item.Quantity @item.Unit</td>
                                                    <td>@item.CaloriesKcal.ToString("N0")</td>
                                                    <td>@item.ProteinG.ToString("N0")</td>
                                                    <td>@item.CarbsG.ToString("N0")</td>
                                                    <td>@item.FatG.ToString("N0")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        }
                    }
                </ChildContent>
            </Panel>
        }

        @if (_showDeleteConfirm)
        {
            <div class="table-card delete-card section-animate">
                <div class="delete-confirm">
                    <p class="delete-title">Confirm Deletion</p>
                    <p class="delete-desc">
                        Are you sure you want to delete <strong>@_plan.Title</strong>?
                    </p>
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <p class="delete-error">@_errorMessage</p>
                    }
                    <div class="delete-actions">
                        <Button Variant="ButtonVariant.Primary" OnClick="ConfirmDelete" Disabled="@_isProcessing">
                            @(_isProcessing ? "Deleting..." : "Yes, Delete")
                        </Button>
                        <Button Variant="ButtonVariant.Ghost" OnClick="@(() => _showDeleteConfirm = false)">Cancel</Button>
                    </div>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="success-msg">@_successMessage</div>
        }

        <div class="meta-footer">
            <span>Created: @_plan.CreatedAt.ToString("MMM d, yyyy h:mm tt") UTC</span>
            @if (_plan.UpdatedAt.HasValue)
            {
                <span> · Updated: @_plan.UpdatedAt.Value.ToString("MMM d, yyyy h:mm tt") UTC</span>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;

    private MealPlanDetailDto? _plan;
    private bool _isLoading = true;
    private bool _isProcessing;
    private bool _showDeleteConfirm;
    private string? _errorMessage;
    private string? _successMessage;

    protected override async Task OnInitializedAsync()
    {
        _plan = await MealPlanService.GetByIdAsync(Id);
        _isLoading = false;

        if (_plan is not null)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "unknown";
            await AuditLogService.LogAsync(userId, "MealPlanViewed", "MealPlan", Id.ToString(), "Viewed MealPlan record");
        }
    }

    private async Task<string> GetUserId()
    {
        var authState = await AuthState;
        return authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
    }

    private void NavigateToEdit() => NavigationManager.NavigateTo($"/meal-plans/{Id}/edit");
    private void NavigateToEditDetails() => NavigationManager.NavigateTo($"/meal-plans/{Id}/edit-details");

    private async Task ActivatePlan()
    {
        _isProcessing = true;
        var userId = await GetUserId();
        await MealPlanService.UpdateStatusAsync(Id, MealPlanStatus.Active, userId);
        _plan = await MealPlanService.GetByIdAsync(Id);
        _isProcessing = false;
    }

    private async Task ArchivePlan()
    {
        _isProcessing = true;
        var userId = await GetUserId();
        await MealPlanService.UpdateStatusAsync(Id, MealPlanStatus.Archived, userId);
        _plan = await MealPlanService.GetByIdAsync(Id);
        _isProcessing = false;
    }

    private async Task ReactivatePlan()
    {
        _isProcessing = true;
        var userId = await GetUserId();
        await MealPlanService.UpdateStatusAsync(Id, MealPlanStatus.Active, userId);
        _plan = await MealPlanService.GetByIdAsync(Id);
        _isProcessing = false;
    }

    private async Task DuplicatePlan()
    {
        _isProcessing = true;
        var userId = await GetUserId();
        var result = await MealPlanService.DuplicateAsync(Id, userId);
        if (result)
        {
            _successMessage = "Plan duplicated as Draft.";
        }
        _isProcessing = false;
    }

    private async Task ConfirmDelete()
    {
        _isProcessing = true;
        _errorMessage = null;
        try
        {
            var userId = await GetUserId();
            var success = await MealPlanService.SoftDeleteAsync(Id, userId);
            if (success)
            {
                NavigationManager.NavigateTo("/meal-plans");
            }
            else
            {
                _errorMessage = "Failed to delete the meal plan.";
            }
        }
        catch
        {
            _errorMessage = "An error occurred while deleting the meal plan.";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private static string FormatMealType(MealType type) => type switch
    {
        MealType.Breakfast => "Breakfast",
        MealType.MorningSnack => "Morning Snack",
        MealType.Lunch => "Lunch",
        MealType.AfternoonSnack => "Afternoon Snack",
        MealType.Dinner => "Dinner",
        MealType.EveningSnack => "Evening Snack",
        _ => type.ToString()
    };

    private static BadgeVariant GetStatusVariant(MealPlanStatus status) => status switch
    {
        MealPlanStatus.Draft => BadgeVariant.Secondary,
        MealPlanStatus.Active => BadgeVariant.Success,
        MealPlanStatus.Archived => BadgeVariant.Accent,
        _ => BadgeVariant.Primary
    };
}
