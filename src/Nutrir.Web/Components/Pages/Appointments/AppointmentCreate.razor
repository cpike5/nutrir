@page "/appointments/new"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Nutrir.Core.DTOs
@using Nutrir.Core.Enums
@using Nutrir.Core.Interfaces
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IAppointmentService AppointmentService
@inject IClientService ClientService
@inject NavigationManager NavigationManager

<PageTitle>New Appointment â€” Nutrir</PageTitle>

<div class="form-page">
    <div class="page-header">
        <a href="/appointments" class="back-link" aria-label="Back to appointments">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M12 5l-5 5 5 5"/>
            </svg>
        </a>
        <h1 class="page-title">New Appointment</h1>
    </div>

    <div class="table-card">
        <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="CreateAppointment">
            <DataAnnotationsValidator />

            <!-- Section: Client -->
            <div class="section-header" @onclick='() => ToggleSection("Client")'>
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="8" cy="5" r="3"/>
                    <path d="M2 14c0-3 2.5-5 6-5s6 2 6 5"/>
                </svg>
                Client
                <svg class="section-chevron @(_expandedSections.Contains("Client") ? "" : "collapsed")" width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 6l4 4 4-4"/>
                </svg>
            </div>
            @if (_expandedSections.Contains("Client"))
            {
            <div class="form-body">
                <FormGroup Label="Client" Id="clientId" Error="@GetFieldError(nameof(_model.ClientId))">
                    <FormSelect Id="clientId"
                                Value="@_model.ClientId"
                                ValueChanged="@(v => _model.ClientId = v)">
                        <option value="">Select a client...</option>
                        @foreach (var client in _clients)
                        {
                            <option value="@client.Id">@client.FirstName @client.LastName</option>
                        }
                    </FormSelect>
                </FormGroup>

                <FormGroup Label="Appointment Type" Id="type">
                    <FormSelect Id="type"
                                Value="@_model.Type"
                                ValueChanged="@(v => _model.Type = v)">
                        <option value="InitialConsultation">Initial Consultation</option>
                        <option value="FollowUp">Follow-Up</option>
                        <option value="CheckIn">Check-In</option>
                    </FormSelect>
                </FormGroup>
            </div>
            }

            <!-- Section: Schedule -->
            <div class="section-header" @onclick='() => ToggleSection("Schedule")'>
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="2" y="2.5" width="12" height="12" rx="2"/>
                    <path d="M5 1v3M11 1v3M2 6.5h12"/>
                </svg>
                Schedule
                <svg class="section-chevron @(_expandedSections.Contains("Schedule") ? "" : "collapsed")" width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 6l4 4 4-4"/>
                </svg>
            </div>
            @if (_expandedSections.Contains("Schedule"))
            {
            <div class="form-body">
                <div class="form-grid">
                    <FormGroup Label="Date" Id="date" Error="@GetFieldError(nameof(_model.Date))">
                        <FormInput Id="date" Type="date"
                                   Value="@_model.Date"
                                   ValueChanged="@(v => _model.Date = v)" />
                    </FormGroup>

                    <FormGroup Label="Time" Id="time" Error="@GetFieldError(nameof(_model.Time))">
                        <FormInput Id="time" Type="time"
                                   Value="@_model.Time"
                                   ValueChanged="@(v => _model.Time = v)" />
                    </FormGroup>
                </div>

                <FormGroup Label="Duration" Id="duration">
                    <FormSelect Id="duration"
                                Value="@_model.Duration"
                                ValueChanged="@(v => _model.Duration = v)">
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60">60 minutes</option>
                        <option value="75">75 minutes</option>
                        <option value="90">90 minutes</option>
                    </FormSelect>
                </FormGroup>
            </div>
            }

            <!-- Section: Location -->
            <div class="section-header" @onclick='() => ToggleSection("Location")'>
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M8 1.5a4.5 4.5 0 0 1 4.5 4.5c0 3.5-4.5 8.5-4.5 8.5S3.5 9.5 3.5 6A4.5 4.5 0 0 1 8 1.5Z"/>
                    <circle cx="8" cy="6" r="1.5"/>
                </svg>
                Location
                <svg class="section-chevron @(_expandedSections.Contains("Location") ? "" : "collapsed")" width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 6l4 4 4-4"/>
                </svg>
            </div>
            @if (_expandedSections.Contains("Location"))
            {
            <div class="form-body">
                <FormGroup Label="Location" Id="location">
                    <FormSelect Id="location"
                                Value="@_model.Location"
                                ValueChanged="OnLocationChanged">
                        <option value="InPerson">In-Person</option>
                        <option value="Virtual">Virtual</option>
                        <option value="Phone">Phone</option>
                    </FormSelect>
                </FormGroup>

                @if (_model.Location == "InPerson")
                {
                    <FormGroup Label="Location Notes" Id="locationNotes">
                        <FormInput Id="locationNotes"
                                   Value="@_model.LocationNotes"
                                   ValueChanged="@(v => _model.LocationNotes = v)"
                                   Placeholder="Address or room number..." />
                    </FormGroup>
                }

                @if (_model.Location == "Virtual")
                {
                    <FormGroup Label="Virtual Meeting URL" Id="virtualUrl">
                        <FormInput Id="virtualUrl" Type="url"
                                   Value="@_model.VirtualMeetingUrl"
                                   ValueChanged="@(v => _model.VirtualMeetingUrl = v)"
                                   Placeholder="https://meet.example.com/..." />
                    </FormGroup>
                }
            </div>
            }

            <!-- Section: Notes -->
            <div class="section-header" @onclick='() => ToggleSection("Notes")'>
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M13 2H3a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/>
                    <path d="M5 6h6M5 9h4"/>
                </svg>
                Notes
                <svg class="section-chevron @(_expandedSections.Contains("Notes") ? "" : "collapsed")" width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 6l4 4 4-4"/>
                </svg>
            </div>
            @if (_expandedSections.Contains("Notes"))
            {
            <div class="form-body">
                <FormGroup Label="Appointment Notes" Id="notes">
                    <textarea id="notes"
                              class="form-input"
                              rows="3"
                              @bind="_model.Notes"
                              placeholder="Appointment notes..."></textarea>
                </FormGroup>
            </div>
            }

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="error-banner">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M8 1l7 13H1L8 1Z"/>
                        <path d="M8 6v3M8 11.5v.5"/>
                    </svg>
                    @_errorMessage
                </div>
            }

            <!-- Actions -->
            <div class="form-actions">
                <Button Variant="ButtonVariant.Primary" Type="submit" Disabled="@_isSubmitting">
                    @if (_isSubmitting)
                    {
                        <span>Creating...</span>
                    }
                    else
                    {
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="2" y="2.5" width="12" height="12" rx="2"/>
                            <path d="M5 1v3M11 1v3M2 6.5h12"/>
                            <path d="M8 9v4M6 11h4"/>
                        </svg>
                        <span>Create Appointment</span>
                    }
                </Button>
                <a href="/appointments" class="cancel-link">Cancel</a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public int? ClientId { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;

    private AppointmentFormModel _model = new();
    private EditContext? _editContext;
    private List<ClientDto> _clients = [];
    private bool _isSubmitting;
    private string? _errorMessage;
    private HashSet<string> _expandedSections = ["Client", "Schedule", "Location", "Notes"];

    private void ToggleSection(string section)
    {
        if (!_expandedSections.Remove(section))
            _expandedSections.Add(section);
    }

    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_model);
        _clients = await ClientService.GetListAsync();

        if (ClientId.HasValue)
        {
            _model.ClientId = ClientId.Value.ToString();
        }

        _model.Date = DateTime.Now.AddDays(1).ToString("yyyy-MM-dd");
        _model.Time = "09:00";
    }

    private void OnLocationChanged(string value)
    {
        _model.Location = value;
        if (value != "Virtual") _model.VirtualMeetingUrl = null;
        if (value != "InPerson") _model.LocationNotes = null;
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            if (string.IsNullOrEmpty(_model.ClientId) || !int.TryParse(_model.ClientId, out var clientId))
            {
                _errorMessage = "Please select a client.";
                return;
            }

            if (string.IsNullOrEmpty(_model.Date) || string.IsNullOrEmpty(_model.Time))
            {
                _errorMessage = "Date and time are required.";
                return;
            }

            if (!DateTime.TryParse($"{_model.Date} {_model.Time}", out var startTime))
            {
                _errorMessage = "Invalid date or time.";
                return;
            }

            var utcStartTime = DateTime.SpecifyKind(startTime, DateTimeKind.Local).ToUniversalTime();

            if (!Enum.TryParse<AppointmentType>(_model.Type, out var type))
                type = AppointmentType.FollowUp;

            if (!Enum.TryParse<AppointmentLocation>(_model.Location, out var location))
                location = AppointmentLocation.InPerson;

            if (!int.TryParse(_model.Duration, out var duration))
                duration = 30;

            var authState = await AuthState;
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

            var dto = new CreateAppointmentDto(
                ClientId: clientId,
                Type: type,
                StartTime: utcStartTime,
                DurationMinutes: duration,
                Location: location,
                VirtualMeetingUrl: string.IsNullOrWhiteSpace(_model.VirtualMeetingUrl) ? null : _model.VirtualMeetingUrl,
                LocationNotes: string.IsNullOrWhiteSpace(_model.LocationNotes) ? null : _model.LocationNotes,
                Notes: string.IsNullOrWhiteSpace(_model.Notes) ? null : _model.Notes);

            var created = await AppointmentService.CreateAsync(dto, userId);
            NavigationManager.NavigateTo($"/appointments/{created.Id}");
        }
        catch
        {
            _errorMessage = "An error occurred while creating the appointment. Please try again.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string? GetFieldError(string fieldName)
    {
        if (_editContext is null) return null;
        var messages = _editContext.GetValidationMessages(new FieldIdentifier(_model, fieldName));
        return messages.FirstOrDefault();
    }

    private class AppointmentFormModel
    {
        [Required(ErrorMessage = "Client is required.")]
        public string? ClientId { get; set; }

        public string Type { get; set; } = "FollowUp";

        [Required(ErrorMessage = "Date is required.")]
        public string? Date { get; set; }

        [Required(ErrorMessage = "Time is required.")]
        public string? Time { get; set; }

        public string Duration { get; set; } = "30";

        public string Location { get; set; } = "InPerson";

        public string? VirtualMeetingUrl { get; set; }

        public string? LocationNotes { get; set; }

        public string? Notes { get; set; }
    }
}
