@page "/"
@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Nutrir.Core.DTOs
@using Nutrir.Core.Enums
@using Nutrir.Core.Interfaces
@using Nutrir.Web.Components.UI

@inject IDashboardService DashboardService
@inject IAuditLogService AuditLogService
@inject ITimeZoneService TimeZoneService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Dashboard</PageTitle>

@if (_loading)
{
    <div class="cc-skeleton-container">
        <div class="cc-skeleton cc-skeleton-greeting"></div>
        <div class="cc-skeleton-metrics">
            <div class="cc-skeleton cc-skeleton-metric"></div>
            <div class="cc-skeleton cc-skeleton-metric"></div>
            <div class="cc-skeleton cc-skeleton-metric"></div>
            <div class="cc-skeleton cc-skeleton-metric"></div>
            <div class="cc-skeleton cc-skeleton-metric"></div>
        </div>
        <div class="cc-skeleton-panels">
            <div class="cc-skeleton cc-skeleton-panel"></div>
            <div class="cc-skeleton cc-skeleton-panel"></div>
            <div class="cc-skeleton cc-skeleton-panel"></div>
        </div>
    </div>
}
else
{
    <!-- Greeting -->
    <div class="dash-greeting">
        <h2>Good @GetTimeOfDay(), @_firstName</h2>
        <p><span class="dash-greeting-date">@TimeZoneService.UserNow.ToString("dddd, MMMM d, yyyy")</span></p>
    </div>

    <!-- Quick Actions -->
    <QuickActions />

    <!-- Metrics Bar -->
    <div class="cc-metrics-bar">
        <MetricCard Label="Active Clients"
                    Value="@_metrics!.TotalActiveClients.ToString()"
                    DeltaText="@(_metrics.NewClientsThisMonth > 0 ? $"+{_metrics.NewClientsThisMonth}" : null)"
                    Delta="@(_metrics.NewClientsThisMonth > 0 ? MetricDelta.Up : MetricDelta.Flat)" />
        <MetricCard Label="Today's Appts"
                    Value="@_todaysAppointments.Count.ToString()"
                    Delta="@(_todaysAppointments.Count > 0 ? MetricDelta.Up : MetricDelta.Flat)" />
        <MetricCard Label="This Week"
                    Value="@_thisWeekCount.ToString()"
                    Delta="@(_thisWeekCount > 0 ? MetricDelta.Up : MetricDelta.Flat)" />
        <MetricCard Label="Active Plans"
                    Value="@_activePlanCount.ToString()"
                    Delta="@(_activePlanCount > 0 ? MetricDelta.Up : MetricDelta.Flat)" />
        <MetricCard Label="Pending Consent"
                    Value="@_metrics.PendingConsentCount.ToString()"
                    DeltaText="@(_metrics.PendingConsentCount > 0 ? _metrics.PendingConsentCount.ToString() : null)"
                    Delta="@(_metrics.PendingConsentCount > 0 ? MetricDelta.Down : MetricDelta.Flat)" />
    </div>

    <!-- Main 3-Column Grid -->
    <div class="cc-grid">

        <!-- Today's Schedule -->
        <Panel Title="Today's Schedule" Count="@(_todaysAppointments.Count > 0 ? _todaysAppointments.Count : null)">
            <HeaderExtra>
                <a href="/appointments" class="cc-panel-link">View All</a>
            </HeaderExtra>
            <ChildContent>
                @if (_todaysAppointments.Count == 0)
                {
                    <div class="cc-empty-state">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto; display: block; opacity: 0.4;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <p>No appointments today</p>
                    </div>
                }
                else
                {
                    @foreach (var appt in _todaysAppointments)
                    {
                        <ScheduleListItem Time="@TimeZoneService.ToUserLocal(appt.StartTime).ToString("h:mm")"
                                          ClientName="@($"{appt.ClientFirstName} {appt.ClientLastName}")"
                                          Duration="@appt.DurationMinutes"
                                          Type="@appt.Type"
                                          Status="@appt.Status"
                                          Location="@appt.Location"
                                          Href="@($"/appointments/{appt.Id}")" />
                    }
                }
            </ChildContent>
        </Panel>

        <!-- Recent Clients -->
        <Panel Title="Recent Clients">
            <HeaderExtra>
                <a href="/clients" class="cc-panel-link">View All</a>
            </HeaderExtra>
            <ChildContent>
                @if (_recentClients.Count == 0)
                {
                    <div class="cc-empty-state">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto; display: block; opacity: 0.4;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        </svg>
                        <p>No clients yet</p>
                        <a href="/clients/new" class="cc-empty-cta">Add your first client</a>
                    </div>
                }
                else
                {
                    @foreach (var client in _recentClients)
                    {
                        <ClientRow Initials="@GetInitials(client)"
                                   Name="@($"{client.FirstName} {client.LastName}")"
                                   Meta="@GetClientMeta(client)"
                                   StatusVariant="@(client.ConsentGiven ? BadgeVariant.Success : BadgeVariant.Warning)"
                                   StatusText="@(client.ConsentGiven ? "Active" : "Pending")"
                                   Href="@($"/clients/{client.Id}")" />
                    }
                }
            </ChildContent>
        </Panel>

        <!-- Activity Feed -->
        <Panel Title="Activity">
            <HeaderExtra>
                <span class="cc-panel-count">Recent</span>
            </HeaderExtra>
            <ChildContent>
                @if (_activityItems.Count == 0)
                {
                    <div class="cc-empty-state">No recent activity</div>
                }
                else
                {
                    @foreach (var entry in _activityItems)
                    {
                        <ActivityItem DotClass="@GetActivityDotClass(entry.Action)"
                                      TimeAgo="@FormatTimeAgo(entry.Timestamp)">
                            @((MarkupString)FormatActivityText(entry))
                        </ActivityItem>
                    }
                }
            </ChildContent>
        </Panel>

    </div>

    <!-- Secondary 2-Column Grid -->
    <div class="cc-grid-secondary">

        <!-- Alerts & Reminders -->
        <Panel Title="Alerts & Reminders" Count="@_consentAlerts.Count">
            @if (_consentAlerts.Count == 0)
            {
                <div class="cc-empty-state">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto; display: block;">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <p>All clear â€” no alerts</p>
                </div>
            }
            else
            {
                @foreach (var client in _consentAlerts)
                {
                    <AlertItem Severity="AlertSeverity.Warning"
                               Text="@($"{client.FirstName} {client.LastName} \u2014 consent not yet recorded")"
                               Subtitle="@($"Added {FormatTimeAgo(client.CreatedAt)}")"
                               Href="@($"/clients/{client.Id}")" />
                }
            }
        </Panel>

        <!-- Recent Meal Plans -->
        <Panel Title="Recent Meal Plans" Count="@(_recentMealPlans.Count > 0 ? _recentMealPlans.Count : null)">
            <HeaderExtra>
                <a href="/meal-plans" class="cc-panel-link">View All</a>
            </HeaderExtra>
            <ChildContent>
                @if (_recentMealPlans.Count == 0)
                {
                    <div class="cc-empty-state">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto; display: block; opacity: 0.4;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <p>No meal plans yet</p>
                    </div>
                }
                else
                {
                    @foreach (var plan in _recentMealPlans)
                    {
                        <a href="/meal-plans/@plan.Id" class="cc-list-item">
                            <div class="cc-list-content">
                                <div class="cc-list-primary">@plan.Title</div>
                                <div class="cc-list-secondary">@plan.ClientFirstName @plan.ClientLastName</div>
                            </div>
                            <div class="cc-list-badge">
                                <Badge Variant="@GetPlanStatusVariant(plan.Status)">@plan.Status</Badge>
                            </div>
                        </a>
                    }
                }
            </ChildContent>
        </Panel>

    </div>
}

@code {
    private bool _loading = true;
    private string _firstName = "";
    private DashboardMetricsDto? _metrics;
    private List<ClientDto> _recentClients = [];
    private List<ClientDto> _consentAlerts = [];
    private List<AuditLogDto> _activityItems = [];
    private List<AppointmentDto> _todaysAppointments = [];
    private int _thisWeekCount;
    private int _activePlanCount;
    private List<MealPlanSummaryDto> _recentMealPlans = [];

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _firstName = user.FindFirst("FirstName")?.Value
                     ?? user.Identity?.Name?.Split('@')[0]
                     ?? "there";

        _metrics = await DashboardService.GetMetricsAsync();
        _recentClients = await DashboardService.GetRecentClientsAsync(7);
        _consentAlerts = await DashboardService.GetClientsMissingConsentAsync();
        _activityItems = await AuditLogService.GetRecentAsync(8);
        _todaysAppointments = await DashboardService.GetTodaysAppointmentsAsync();
        _thisWeekCount = await DashboardService.GetThisWeekAppointmentCountAsync();
        _activePlanCount = await DashboardService.GetActiveMealPlanCountAsync();
        _recentMealPlans = await DashboardService.GetRecentMealPlansAsync(5);
        _loading = false;
    }

    private static string GetInitials(ClientDto client)
    {
        var first = client.FirstName.Length > 0 ? client.FirstName[0].ToString().ToUpper() : "";
        var last = client.LastName.Length > 0 ? client.LastName[0].ToString().ToUpper() : "";
        return $"{first}{last}";
    }

    private static string GetClientMeta(ClientDto client)
    {
        var timeAgo = FormatTimeAgo(client.CreatedAt);
        var status = client.ConsentGiven ? "Consented" : "Consent pending";
        return $"Added {timeAgo} \u00b7 {status}";
    }

    private static string GetActivityDotClass(string action)
    {
        if (action == "ClientCreated") return "dot-client";
        if (action == "ClientUpdated") return "dot-note";
        if (action == "ClientSoftDeleted") return "dot-appt";
        if (action.StartsWith("Appointment")) return "dot-appt";
        if (action.StartsWith("MealPlan")) return "dot-plan";
        return "dot-client";
    }

    private static BadgeVariant GetPlanStatusVariant(MealPlanStatus status) => status switch
    {
        MealPlanStatus.Draft => BadgeVariant.Secondary,
        MealPlanStatus.Active => BadgeVariant.Success,
        MealPlanStatus.Archived => BadgeVariant.Accent,
        _ => BadgeVariant.Primary
    };

    private static string FormatActivityText(AuditLogDto entry)
    {
        if (!string.IsNullOrEmpty(entry.Details))
        {
            var details = entry.Details;
            var parts = details.Split(" client ", 2);
            if (parts.Length == 2)
            {
                var verb = "activity recorded";
                if (entry.Action == "ClientCreated") verb = "added as new client";
                else if (entry.Action == "ClientUpdated") verb = "record updated";
                return $"<strong>{System.Net.WebUtility.HtmlEncode(parts[1])}</strong> {verb}";
            }
            return System.Net.WebUtility.HtmlEncode(details);
        }

        return $"{entry.Action} on {entry.EntityType}";
    }

    private static string FormatTimeAgo(DateTime utcTimestamp)
    {
        var elapsed = DateTime.UtcNow - utcTimestamp;

        if (elapsed.TotalMinutes < 1) return "now";
        if (elapsed.TotalMinutes < 60) return $"{(int)elapsed.TotalMinutes}m";
        if (elapsed.TotalHours < 24) return $"{(int)elapsed.TotalHours}h";
        if (elapsed.TotalDays < 30) return $"{(int)elapsed.TotalDays}d";
        return $"{(int)(elapsed.TotalDays / 30)}mo";
    }

    private string GetTimeOfDay()
    {
        var hour = TimeZoneService.UserNow.Hour;
        if (hour < 12) return "morning";
        if (hour < 17) return "afternoon";
        return "evening";
    }
}
