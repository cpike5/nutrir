@page "/clients"
@rendermode InteractiveServer
@implements IDisposable
@using Microsoft.AspNetCore.Authorization
@using Nutrir.Core.DTOs
@using Nutrir.Core.Interfaces
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IClientService ClientService
@inject NavigationManager NavigationManager

<PageTitle>Clients — Nutrir</PageTitle>

<Breadcrumb Items="@(new[] { new BreadcrumbItem("Clients") })" />

<div class="clients-page">
    <div class="clients-header">
        <div class="clients-header-text">
            <h1 class="clients-title">Clients</h1>
        </div>
        <Button Variant="ButtonVariant.Primary" OnClick="NavigateToCreate">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M11 4a3 3 0 1 0-6 0 3 3 0 0 0 6 0Z"/>
                <path d="M2 13.5c0-2.5 2.5-4 6-4s6 1.5 6 4"/>
                <path d="M13 2v4M11 4h4"/>
            </svg>
            Add Client
        </Button>
    </div>

    <div class="toolbar" role="toolbar" aria-label="Client list controls">
        <div class="search-wrapper" role="search">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="7" cy="7" r="4.5"/>
                <path d="m10.5 10.5 3 3"/>
            </svg>
            <label for="client-search" class="sr-only">Search clients</label>
            <input type="search"
                   id="client-search"
                   class="search-input"
                   placeholder="Search by name, email, or phone..."
                   autocomplete="off"
                   value="@_searchTerm"
                   @oninput="OnSearchInput" />
        </div>

        <div class="filter-group">
            <label for="consent-filter" class="filter-label">Consent</label>
            <select id="consent-filter" class="filter-select" value="@_consentFilter" @onchange="OnConsentFilterChanged">
                <option value="">All</option>
                <option value="Given">Given</option>
                <option value="Pending">Pending</option>
            </select>
        </div>

        <span class="client-count" aria-live="polite">
            <strong>@(FilteredClients.Count)</strong> clients
        </span>
    </div>

    @if (_isLoading)
    {
        <div class="table-card">
            <p class="clients-loading">Loading clients...</p>
        </div>
    }
    else if (_clients is null || _clients.Count == 0)
    {
        <div class="table-card">
            <div class="empty-state" role="status">
                <svg class="empty-state-icon" viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="32" cy="24" r="10" stroke-opacity="0.5"/>
                    <path d="M14 54c0-8 7-14 18-14s18 6 18 14" stroke-opacity="0.5"/>
                    <path d="M44 12l8 8M52 12l-8 8" stroke-opacity="0.35"/>
                </svg>
                <p class="empty-state-title">No clients found</p>
                <p class="empty-state-desc">
                    @if (string.IsNullOrEmpty(_searchTerm))
                    {
                        <span>Get started by adding your first client.</span>
                    }
                    else
                    {
                        <span>Try adjusting your search criteria.</span>
                    }
                </p>
            </div>
        </div>
    }
    else if (FilteredClients.Count == 0)
    {
        <div class="table-card">
            <div class="empty-state" role="status">
                <svg class="empty-state-icon" viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="32" cy="24" r="10" stroke-opacity="0.5"/>
                    <path d="M14 54c0-8 7-14 18-14s18 6 18 14" stroke-opacity="0.5"/>
                    <path d="M44 12l8 8M52 12l-8 8" stroke-opacity="0.35"/>
                </svg>
                <p class="empty-state-title">No matching clients</p>
                <p class="empty-state-desc">
                    <span>Try adjusting your filter or search criteria.</span>
                </p>
            </div>
        </div>
    }
    else
    {
        <div class="table-card">
            <table class="clients-table" role="grid">
                <thead>
                    <tr>
                        <th scope="col" class="col-client sortable" aria-sort="@GetAriaSort("Name")" tabindex="0"
                            @onclick="@(() => OnSortColumn("Name"))" @onkeydown="@(e => OnSortKeyDown(e, "Name"))">
                            Client <span class="sort-indicator" aria-hidden="true">@GetSortIcon("Name")</span>
                        </th>
                        <th scope="col" class="col-phone">Phone</th>
                        <th scope="col" class="col-nutritionist sortable" aria-sort="@GetAriaSort("Nutritionist")" tabindex="0"
                            @onclick="@(() => OnSortColumn("Nutritionist"))" @onkeydown="@(e => OnSortKeyDown(e, "Nutritionist"))">
                            Nutritionist <span class="sort-indicator" aria-hidden="true">@GetSortIcon("Nutritionist")</span>
                        </th>
                        <th scope="col" class="col-consent sortable" aria-sort="@GetAriaSort("Consent")" tabindex="0"
                            @onclick="@(() => OnSortColumn("Consent"))" @onkeydown="@(e => OnSortKeyDown(e, "Consent"))">
                            Consent <span class="sort-indicator" aria-hidden="true">@GetSortIcon("Consent")</span>
                        </th>
                        <th scope="col" class="col-date sortable" aria-sort="@GetAriaSort("Created")" tabindex="0"
                            @onclick="@(() => OnSortColumn("Created"))" @onkeydown="@(e => OnSortKeyDown(e, "Created"))">
                            Created <span class="sort-indicator" aria-hidden="true">@GetSortIcon("Created")</span>
                        </th>
                        <th scope="col"><span class="sr-only">Actions</span></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var client in FilteredClients)
                    {
                        <tr>
                            <td>
                                <div class="client-identity">
                                    <div class="client-avatar" aria-hidden="true">@GetInitials(client)</div>
                                    <div class="client-info">
                                        <div class="client-name">@client.FirstName @client.LastName</div>
                                        <div class="client-email">@(client.Email ?? "—")</div>
                                    </div>
                                </div>
                            </td>
                            <td class="col-phone cell-phone">@(PhoneFormatter.FormatOrNull(client.Phone) ?? "—")</td>
                            <td class="col-nutritionist cell-nutritionist">@(client.PrimaryNutritionistName ?? client.PrimaryNutritionistId)</td>
                            <td class="col-consent cell-consent">
                                @if (client.ConsentGiven)
                                {
                                    <Badge Variant="BadgeVariant.Success"><span class="badge-dot"></span> Given</Badge>
                                }
                                else
                                {
                                    <Badge Variant="BadgeVariant.Warning"><span class="badge-dot"></span> Pending</Badge>
                                }
                            </td>
                            <td class="col-date cell-date">@client.CreatedAt.ToString("MMM d, yyyy")</td>
                            <td>
                                <div class="row-actions">
                                    <a href="clients/@client.Id" class="btn-icon" aria-label="View @client.FirstName @client.LastName">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1.5 8s2.5-5 6.5-5 6.5 5 6.5 5-2.5 5-6.5 5S1.5 8 1.5 8Z"/><circle cx="8" cy="8" r="2"/></svg>
                                    </a>
                                    <a href="clients/@client.Id/edit" class="btn-icon" aria-label="Edit @client.FirstName @client.LastName">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11.5 2.5a1.77 1.77 0 0 1 2.5 2.5L5.5 13.5l-3.5 1 1-3.5Z"/></svg>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<ClientDto>? _clients;
    private string? _searchTerm;
    private bool _isLoading = true;
    private System.Threading.Timer? _debounceTimer;

    private string? _sortColumn;
    private bool _sortAscending = true;
    private string _consentFilter = "";

    private IReadOnlyList<ClientDto> FilteredClients
    {
        get
        {
            if (_clients is null || _clients.Count == 0)
                return Array.Empty<ClientDto>();

            IEnumerable<ClientDto> result = _clients;

            // Apply consent filter
            if (_consentFilter == "Given")
                result = result.Where(c => c.ConsentGiven);
            else if (_consentFilter == "Pending")
                result = result.Where(c => !c.ConsentGiven);

            // Apply sort
            if (!string.IsNullOrEmpty(_sortColumn))
            {
                result = (_sortColumn, _sortAscending) switch
                {
                    ("Name", true) => result.OrderBy(c => c.LastName).ThenBy(c => c.FirstName),
                    ("Name", false) => result.OrderByDescending(c => c.LastName).ThenByDescending(c => c.FirstName),
                    ("Nutritionist", true) => result.OrderBy(c => c.PrimaryNutritionistName ?? string.Empty),
                    ("Nutritionist", false) => result.OrderByDescending(c => c.PrimaryNutritionistName ?? string.Empty),
                    ("Consent", true) => result.OrderBy(c => c.ConsentGiven),
                    ("Consent", false) => result.OrderByDescending(c => c.ConsentGiven),
                    ("Created", true) => result.OrderBy(c => c.CreatedAt),
                    ("Created", false) => result.OrderByDescending(c => c.CreatedAt),
                    _ => result
                };
            }

            return result.ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadClientsAsync();
    }

    private async Task LoadClientsAsync()
    {
        _isLoading = true;
        _clients = await ClientService.GetListAsync(_searchTerm);
        _isLoading = false;
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _searchTerm = e.Value?.ToString();
        _sortColumn = null;
        _sortAscending = true;
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadClientsAsync();
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    private void OnSortColumn(string column)
    {
        if (_sortColumn == column)
        {
            if (_sortAscending)
            {
                _sortAscending = false;
            }
            else
            {
                _sortColumn = null;
                _sortAscending = true;
            }
        }
        else
        {
            _sortColumn = column;
            _sortAscending = true;
        }
    }

    private void OnSortKeyDown(KeyboardEventArgs e, string column)
    {
        if (e.Key == "Enter" || e.Key == " ")
            OnSortColumn(column);
    }

    private void OnConsentFilterChanged(ChangeEventArgs e)
    {
        _consentFilter = e.Value?.ToString() ?? "";
    }

    private string GetAriaSort(string column)
    {
        if (_sortColumn != column)
            return "none";
        return _sortAscending ? "ascending" : "descending";
    }

    private string GetSortIcon(string column)
    {
        if (_sortColumn != column)
            return "\u2195"; // ↕ up-down arrow (unsorted)
        return _sortAscending ? "\u2191" : "\u2193"; // ↑ or ↓
    }

    private static string GetInitials(ClientDto client)
    {
        var first = client.FirstName.Length > 0 ? client.FirstName[0] : '?';
        var last = client.LastName.Length > 0 ? client.LastName[0] : '?';
        return $"{char.ToUpper(first)}{char.ToUpper(last)}";
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo("/clients/new");
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
