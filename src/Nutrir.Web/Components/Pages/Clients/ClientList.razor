@page "/clients"
@rendermode InteractiveServer
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Authorization
@using Nutrir.Core.DTOs
@using Nutrir.Core.Enums
@using Nutrir.Core.Interfaces
@using Nutrir.Web.Services
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IClientService ClientService
@inject NavigationManager NavigationManager
@inject RealTimeNotificationService NotificationService

<PageTitle>Clients — Nutrir</PageTitle>

<Breadcrumb Items="@(new[] { new BreadcrumbItem("Clients") })" />

<div class="clients-page">
    <div class="clients-header">
        <div class="clients-header-text">
            <h1 class="clients-title">Clients</h1>
        </div>
        <Button Variant="ButtonVariant.Primary" OnClick="NavigateToCreate">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M11 4a3 3 0 1 0-6 0 3 3 0 0 0 6 0Z"/>
                <path d="M2 13.5c0-2.5 2.5-4 6-4s6 1.5 6 4"/>
                <path d="M13 2v4M11 4h4"/>
            </svg>
            Add Client
        </Button>
    </div>

    <DataGrid TItem="ClientDto"
              Items="@_result?.Items"
              TotalCount="@(_result?.TotalCount ?? 0)"
              Page="@_query.Page"
              PageSize="@_query.PageSize"
              SortColumn="@_query.SortColumn"
              SortDirection="@_query.SortDirection"
              OnQueryChanged="HandleQueryChanged"
              IsLoading="@_isLoading"
              ShowRealtimeBanner="@_refreshedByRealTime">
        <ToolbarContent>
            <div class="search-wrapper" role="search">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="7" cy="7" r="4.5"/>
                    <path d="m10.5 10.5 3 3"/>
                </svg>
                <label for="client-search" class="sr-only">Search clients</label>
                <input type="search"
                       id="client-search"
                       class="search-input"
                       placeholder="Search by name, email, or phone..."
                       autocomplete="off"
                       value="@_query.SearchTerm"
                       @oninput="OnSearchInput" />
            </div>
            <div class="filter-group">
                <label for="consent-filter" class="filter-label">Consent</label>
                <select id="consent-filter" class="filter-select" @onchange="OnConsentFilterChanged">
                    <option value="">All</option>
                    <option value="Given" selected="@(_query.ConsentFilter == "Given")">Given</option>
                    <option value="Pending" selected="@(_query.ConsentFilter == "Pending")">Pending</option>
                </select>
            </div>
            <span class="client-count" aria-live="polite">
                <strong>@(_result?.TotalCount ?? 0)</strong> clients
            </span>
        </ToolbarContent>
        <Columns>
            <DataGridColumn TItem="ClientDto" Key="name" Header="Client" Sortable>
                <CellTemplate Context="client">
                    <div class="client-identity">
                        <div class="client-avatar" aria-hidden="true">@GetInitials(client)</div>
                        <div class="client-info">
                            <div class="client-name">@client.FirstName @client.LastName</div>
                            <div class="client-email">@(client.Email ?? "—")</div>
                        </div>
                    </div>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="ClientDto" Key="phone" Header="Phone" HideBelow="hide-below-860">
                <CellTemplate Context="client">
                    <span class="cell-phone">@(PhoneFormatter.FormatOrNull(client.Phone) ?? "—")</span>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="ClientDto" Key="nutritionist" Header="Nutritionist" HideBelow="hide-below-860">
                <CellTemplate Context="client">
                    <span class="cell-nutritionist">@(client.PrimaryNutritionistName ?? client.PrimaryNutritionistId)</span>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="ClientDto" Key="consent" Header="Consent" Sortable HideBelow="hide-below-600">
                <CellTemplate Context="client">
                    @if (client.ConsentGiven)
                    {
                        <Badge Variant="BadgeVariant.Success"><span class="badge-dot"></span> Given</Badge>
                    }
                    else
                    {
                        <Badge Variant="BadgeVariant.Warning"><span class="badge-dot"></span> Pending</Badge>
                    }
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="ClientDto" Key="lastappointment" Header="Last Appt" Sortable HideBelow="hide-below-860">
                <CellTemplate Context="client">
                    <span class="cell-date">@(client.LastAppointmentDate?.ToString("MMM d, yyyy") ?? "—")</span>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="ClientDto" Key="created" Header="Created" Sortable HideBelow="hide-below-600">
                <CellTemplate Context="client">
                    <span class="cell-date">@client.CreatedAt.ToString("MMM d, yyyy")</span>
                </CellTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="ClientDto" Key="actions" Header="">
                <CellTemplate Context="client">
                    <div class="row-actions">
                        <a href="clients/@client.Id" class="btn-icon" aria-label="View @client.FirstName @client.LastName">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1.5 8s2.5-5 6.5-5 6.5 5 6.5 5-2.5 5-6.5 5S1.5 8 1.5 8Z"/><circle cx="8" cy="8" r="2"/></svg>
                        </a>
                        <a href="clients/@client.Id/edit" class="btn-icon" aria-label="Edit @client.FirstName @client.LastName">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11.5 2.5a1.77 1.77 0 0 1 2.5 2.5L5.5 13.5l-3.5 1 1-3.5Z"/></svg>
                        </a>
                    </div>
                </CellTemplate>
            </DataGridColumn>
        </Columns>
        <EmptyContent>
            <div class="empty-state" role="status">
                <svg class="empty-state-icon" viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="32" cy="24" r="10" stroke-opacity="0.5"/>
                    <path d="M14 54c0-8 7-14 18-14s18 6 18 14" stroke-opacity="0.5"/>
                    <path d="M44 12l8 8M52 12l-8 8" stroke-opacity="0.35"/>
                </svg>
                <p class="empty-state-title">No clients found</p>
                <p class="empty-state-desc">
                    @if (string.IsNullOrEmpty(_query.SearchTerm) && _query.ConsentFilter is null)
                    {
                        <span>Get started by adding your first client.</span>
                    }
                    else
                    {
                        <span>Try adjusting your search or filter criteria.</span>
                    }
                </p>
            </div>
        </EmptyContent>
    </DataGrid>
</div>

@code {
    private PagedResult<ClientDto>? _result;
    private ClientListQuery _query = new();
    private bool _isLoading = true;
    private bool _refreshedByRealTime;
    private System.Threading.Timer? _debounceTimer;
    private System.Threading.Timer? _notificationDebounceTimer;

    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnEntityChanged += OnEntityChanged;
        await NotificationService.StartAsync();
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _refreshedByRealTime = false;
        _isLoading = true;
        _result = await ClientService.GetPagedAsync(_query);
        _isLoading = false;
    }

    private async Task HandleQueryChanged(GridQuery gridQuery)
    {
        _query = _query with
        {
            Page = gridQuery.Page,
            PageSize = gridQuery.PageSize,
            SortColumn = gridQuery.SortColumn,
            SortDirection = gridQuery.SortDirection
        };
        await LoadDataAsync();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        var searchTerm = e.Value?.ToString();
        _query = _query with { SearchTerm = searchTerm, Page = 1 };
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadDataAsync();
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    private async Task OnConsentFilterChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        _query = _query with { ConsentFilter = string.IsNullOrEmpty(value) ? null : value, Page = 1 };
        await LoadDataAsync();
    }

    private void OnEntityChanged(EntityChangeNotification notification)
    {
        if (notification.EntityType != "Client")
            return;

        _notificationDebounceTimer?.Dispose();
        _notificationDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadDataAsync();
                _refreshedByRealTime = true;
                StateHasChanged();
            });
        }, null, 1500, Timeout.Infinite);
    }

    private static string GetInitials(ClientDto client)
    {
        var first = client.FirstName.Length > 0 ? client.FirstName[0] : '?';
        var last = client.LastName.Length > 0 ? client.LastName[0] : '?';
        return $"{char.ToUpper(first)}{char.ToUpper(last)}";
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo("/clients/new");
    }

    public ValueTask DisposeAsync()
    {
        NotificationService.OnEntityChanged -= OnEntityChanged;
        _debounceTimer?.Dispose();
        _notificationDebounceTimer?.Dispose();
        return ValueTask.CompletedTask;
    }
}
