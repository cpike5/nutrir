@page "/clients/new"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Nutrir.Core.DTOs
@using Nutrir.Core.Interfaces
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IClientService ClientService
@inject NavigationManager NavigationManager

<PageTitle>New Client â€” Nutrir</PageTitle>

<div class="client-form-page">
    <div class="client-form-header">
        <h1 class="client-form-title">New Client</h1>
    </div>

    <Card>
        <div class="client-form-body">
            <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="CreateClient">
                <DataAnnotationsValidator />

                <div class="client-form-grid">
                    <FormGroup Label="First Name" Id="firstName" Error="@GetFieldError(nameof(_model.FirstName))">
                        <FormInput Id="firstName"
                                   Value="@_model.FirstName"
                                   ValueChanged="@(v => _model.FirstName = v)"
                                   Placeholder="Enter first name" />
                    </FormGroup>

                    <FormGroup Label="Last Name" Id="lastName" Error="@GetFieldError(nameof(_model.LastName))">
                        <FormInput Id="lastName"
                                   Value="@_model.LastName"
                                   ValueChanged="@(v => _model.LastName = v)"
                                   Placeholder="Enter last name" />
                    </FormGroup>
                </div>

                <div class="client-form-grid">
                    <FormGroup Label="Email" Id="email">
                        <FormInput Id="email"
                                   Type="email"
                                   Value="@_model.Email"
                                   ValueChanged="@(v => _model.Email = v)"
                                   Placeholder="email@example.com" />
                    </FormGroup>

                    <FormGroup Label="Phone" Id="phone">
                        <FormInput Id="phone"
                                   Type="tel"
                                   Value="@_model.Phone"
                                   ValueChanged="@(v => _model.Phone = v)"
                                   Placeholder="(555) 123-4567" />
                    </FormGroup>
                </div>

                <div class="client-form-grid">
                    <FormGroup Label="Date of Birth" Id="dateOfBirth">
                        <FormInput Id="dateOfBirth"
                                   Type="date"
                                   Value="@_model.DateOfBirth"
                                   ValueChanged="@(v => _model.DateOfBirth = v)" />
                    </FormGroup>

                    <FormGroup Label="Primary Nutritionist ID" Id="nutritionistId">
                        <FormInput Id="nutritionistId"
                                   Value="@_model.PrimaryNutritionistId"
                                   ValueChanged="@(v => _model.PrimaryNutritionistId = v)"
                                   Placeholder="User ID of the nutritionist" />
                    </FormGroup>
                </div>

                <FormGroup Label="Notes" Id="notes">
                    <textarea id="notes"
                              class="form-input"
                              rows="4"
                              @bind="_model.Notes"
                              placeholder="Additional notes about the client..."></textarea>
                </FormGroup>

                <div class="client-form-consent">
                    <FormCheckbox Label="Client has given consent to data collection"
                                  Value="@_model.ConsentGiven"
                                  ValueChanged="OnConsentChanged" />
                </div>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <p class="client-form-error">@_errorMessage</p>
                }

                <div class="client-form-actions">
                    <Button Variant="ButtonVariant.Primary" Type="submit" Disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <span>Creating...</span>
                        }
                        else
                        {
                            <span>Create Client</span>
                        }
                    </Button>
                    <a href="/clients" class="client-form-cancel-link">Cancel</a>
                </div>
            </EditForm>
        </div>
    </Card>
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;

    private ClientFormModel _model = new();
    private EditContext? _editContext;
    private bool _isSubmitting;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
    }

    private void OnConsentChanged(bool value)
    {
        _model.ConsentGiven = value;
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            var authState = await AuthState;
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

            DateOnly? dob = null;
            if (!string.IsNullOrEmpty(_model.DateOfBirth) && DateOnly.TryParse(_model.DateOfBirth, out var parsedDob))
            {
                dob = parsedDob;
            }

            var dto = new ClientDto(
                Id: 0,
                FirstName: _model.FirstName!,
                LastName: _model.LastName!,
                Email: string.IsNullOrWhiteSpace(_model.Email) ? null : _model.Email,
                Phone: string.IsNullOrWhiteSpace(_model.Phone) ? null : _model.Phone,
                DateOfBirth: dob,
                PrimaryNutritionistId: _model.PrimaryNutritionistId ?? string.Empty,
                ConsentGiven: _model.ConsentGiven,
                ConsentTimestamp: _model.ConsentGiven ? DateTime.UtcNow : null,
                ConsentPolicyVersion: _model.ConsentGiven ? "1.0" : null,
                Notes: string.IsNullOrWhiteSpace(_model.Notes) ? null : _model.Notes,
                IsDeleted: false,
                CreatedAt: DateTime.UtcNow,
                UpdatedAt: null,
                DeletedAt: null
            );

            var created = await ClientService.CreateAsync(dto, userId);
            NavigationManager.NavigateTo($"/clients/{created.Id}");
        }
        catch
        {
            _errorMessage = "An error occurred while creating the client. Please try again.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string? GetFieldError(string fieldName)
    {
        if (_editContext is null) return null;
        var messages = _editContext.GetValidationMessages(new FieldIdentifier(_model, fieldName));
        return messages.FirstOrDefault();
    }

    private class ClientFormModel
    {
        [Required(ErrorMessage = "First name is required.")]
        public string? FirstName { get; set; }

        [Required(ErrorMessage = "Last name is required.")]
        public string? LastName { get; set; }

        [EmailAddress(ErrorMessage = "Please enter a valid email address.")]
        public string? Email { get; set; }

        public string? Phone { get; set; }

        public string? DateOfBirth { get; set; }

        public string? PrimaryNutritionistId { get; set; }

        public bool ConsentGiven { get; set; }

        public string? Notes { get; set; }
    }
}
