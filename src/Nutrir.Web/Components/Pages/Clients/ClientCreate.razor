@page "/clients/new"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Nutrir.Core.DTOs
@using Nutrir.Core.Enums
@using Nutrir.Core.Interfaces
@using Nutrir.Core.Models
@using Nutrir.Infrastructure.Configuration
@using Microsoft.Extensions.Options
@using Nutrir.Web.Components.UI
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IClientService ClientService
@inject IConsentFormService ConsentFormService
@inject IConsentFormTemplate ConsentFormTemplate
@inject IOptions<ConsentFormOptions> ConsentFormOptionsAccessor
@inject IUserManagementService UserManagementService
@inject NavigationManager NavigationManager

<PageTitle>New Client — Nutrir</PageTitle>

<Breadcrumb Items="@(new[] { new BreadcrumbItem("Clients", "/clients"), new BreadcrumbItem("New Client") })" />

<div class="form-page">
    <div class="page-header">
        <a href="/clients" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m15 18-6-6 6-6"/>
            </svg>
        </a>
        <h1 class="page-title">New Client</h1>
    </div>

    <div class="table-card">
        <EditForm EditContext="_editContext" OnValidSubmit="HandleSubmit" FormName="CreateClient">
            <DataAnnotationsValidator />

            <div class="section-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/>
                </svg>
                <span class="section-header-label">Client Details</span>
            </div>
            <div class="form-body">
                <div class="form-grid">
                    <FormGroup Label="First Name" Id="firstName" Error="@GetFieldError(nameof(_model.FirstName))">
                        <FormInput Id="firstName"
                                   Value="@_model.FirstName"
                                   ValueChanged="@(v => _model.FirstName = v)"
                                   Placeholder="Enter first name" />
                    </FormGroup>

                    <FormGroup Label="Last Name" Id="lastName" Error="@GetFieldError(nameof(_model.LastName))">
                        <FormInput Id="lastName"
                                   Value="@_model.LastName"
                                   ValueChanged="@(v => _model.LastName = v)"
                                   Placeholder="Enter last name" />
                    </FormGroup>
                </div>

                <div class="form-grid">
                    <FormGroup Label="Email" Id="email">
                        <FormInput Id="email"
                                   Type="email"
                                   Value="@_model.Email"
                                   ValueChanged="@(v => _model.Email = v)"
                                   Placeholder="email@example.com" />
                    </FormGroup>

                    <FormGroup Label="Phone" Id="phone">
                        <FormInput Id="phone"
                                   Type="tel"
                                   Value="@_model.Phone"
                                   ValueChanged="OnPhoneChanged"
                                   Placeholder="(555) 123-4567" />
                    </FormGroup>
                </div>

                <div class="form-grid">
                    <FormGroup Label="Date of Birth" Id="dateOfBirth">
                        <FormInput Id="dateOfBirth"
                                   Type="date"
                                   Value="@_model.DateOfBirth"
                                   ValueChanged="@(v => _model.DateOfBirth = v)" />
                    </FormGroup>

                    <FormGroup Label="Primary Nutritionist" Id="nutritionist" Error="@GetFieldError(nameof(_model.PrimaryNutritionistId))">
                        <Autocomplete Id="nutritionist"
                                      Options="@_nutritionistOptions"
                                      Value="@_model.PrimaryNutritionistId"
                                      ValueChanged="@(v => _model.PrimaryNutritionistId = v)"
                                      DisplayText="@_nutritionistDisplayText"
                                      DisplayTextChanged="@(v => _nutritionistDisplayText = v)"
                                      Placeholder="Search for a nutritionist..." />
                    </FormGroup>
                </div>

                <FormGroup Label="Notes" Id="notes">
                    <textarea id="notes"
                              class="form-input"
                              rows="4"
                              @bind="_model.Notes"
                              placeholder="Additional notes about the client..."></textarea>
                </FormGroup>

                @* ── Consent Section ──────────────────────────── *@
                <div class="consent-section">
                    <div class="consent-section-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        <span>Consent</span>
                    </div>

                    <ConsentFormReview Content="@_consentContent" />

                    <div class="consent-method">
                        <label class="consent-method-option">
                            <input type="radio" name="consentMethod" value="Digital"
                                   checked="@(_model.ConsentMethod == ConsentSignatureMethod.Digital)"
                                   @onchange="@(() => OnConsentMethodChanged(ConsentSignatureMethod.Digital))" />
                            <span class="consent-method-label">Digital consent</span>
                            <span class="consent-method-desc">Client verbally consents now; recorded digitally</span>
                        </label>
                        <label class="consent-method-option">
                            <input type="radio" name="consentMethod" value="Physical"
                                   checked="@(_model.ConsentMethod == ConsentSignatureMethod.Physical)"
                                   @onchange="@(() => OnConsentMethodChanged(ConsentSignatureMethod.Physical))" />
                            <span class="consent-method-label">Print & sign later</span>
                            <span class="consent-method-desc">Download and print the form from the client detail page</span>
                        </label>
                    </div>

                    @if (_model.ConsentMethod == ConsentSignatureMethod.Digital)
                    {
                        <div class="consent-row">
                            <FormCheckbox Label="I acknowledge that the client has reviewed and consents to the above terms"
                                          Value="@_model.ConsentGiven"
                                          ValueChanged="OnConsentChanged" />
                        </div>
                    }
                    else
                    {
                        <div class="consent-info-alert">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            <span>The consent form can be downloaded and printed from the client detail page after creation. The client will be created with consent pending.</span>
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="error-banner">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                    @_errorMessage
                </div>
            }

            <div class="form-actions">
                <Button Variant="ButtonVariant.Primary" Type="submit" Disabled="@_isSubmitting">
                    @if (_isSubmitting)
                    {
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>Create Client</span>
                    }
                </Button>
                <a href="/clients" class="cancel-link">Cancel</a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;

    private ClientFormModel _model = new();
    private EditContext? _editContext;
    private bool _isSubmitting;
    private string? _errorMessage;
    private IReadOnlyList<Autocomplete.AutocompleteOption> _nutritionistOptions = [];
    private string? _nutritionistDisplayText;
    private ConsentFormContent? _consentContent;

    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_model);

        var nutritionists = await UserManagementService.GetUsersAsync(
            roleFilter: "Nutritionist", isActiveFilter: true);

        _nutritionistOptions = nutritionists
            .Select(n => new Autocomplete.AutocompleteOption(n.Id, n.DisplayName))
            .ToList();

        // Default to the current logged-in user if they are a nutritionist
        var authState = await AuthState;
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        var currentUserOption = _nutritionistOptions.FirstOrDefault(o => o.Value == userId);
        if (currentUserOption is not null)
        {
            _model.PrimaryNutritionistId = currentUserOption.Value;
            _nutritionistDisplayText = currentUserOption.Text;
        }

        // Generate consent form content for preview
        _consentContent = ConsentFormTemplate.Generate("(Client Name)", "(Practitioner)", DateTime.UtcNow);
    }

    private void OnPhoneChanged(string value)
    {
        _model.Phone = PhoneFormatter.Format(value);
    }

    private void OnConsentChanged(bool value)
    {
        _model.ConsentGiven = value;
    }

    private void OnConsentMethodChanged(ConsentSignatureMethod method)
    {
        _model.ConsentMethod = method;
        if (method == ConsentSignatureMethod.Physical)
        {
            // Physical consent: client will sign later, consent is granted at creation
            _model.ConsentGiven = true;
        }
        else
        {
            // Digital: require explicit checkbox
            _model.ConsentGiven = false;
        }
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        var isDigital = _model.ConsentMethod == ConsentSignatureMethod.Digital;
        var consentRequired = ConsentFormOptionsAccessor.Value.RequiredOnClientCreation;

        if (isDigital && !_model.ConsentGiven)
        {
            _errorMessage = "Client consent is required before registration.";
            _isSubmitting = false;
            return;
        }

        try
        {
            var authState = await AuthState;
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

            DateOnly? dob = null;
            if (!string.IsNullOrEmpty(_model.DateOfBirth) && DateOnly.TryParse(_model.DateOfBirth, out var parsedDob))
            {
                dob = parsedDob;
            }

            var policyVersion = ConsentFormTemplate.Version;

            var dto = new ClientDto(
                Id: 0,
                FirstName: _model.FirstName!,
                LastName: _model.LastName!,
                Email: string.IsNullOrWhiteSpace(_model.Email) ? null : _model.Email,
                Phone: string.IsNullOrWhiteSpace(_model.Phone) ? null : PhoneFormatter.ToDigits(_model.Phone),
                DateOfBirth: dob,
                PrimaryNutritionistId: _model.PrimaryNutritionistId!,
                PrimaryNutritionistName: null,
                ConsentGiven: true,
                ConsentTimestamp: DateTime.UtcNow,
                ConsentPolicyVersion: policyVersion,
                Notes: string.IsNullOrWhiteSpace(_model.Notes) ? null : _model.Notes,
                IsDeleted: false,
                CreatedAt: DateTime.UtcNow,
                UpdatedAt: null,
                DeletedAt: null
            );

            var created = await ClientService.CreateAsync(dto, userId);

            // Record consent form based on method
            if (isDigital)
            {
                await ConsentFormService.RecordDigitalSignatureAsync(created.Id, userId);
            }

            NavigationManager.NavigateTo($"/clients/{created.Id}");
        }
        catch
        {
            _errorMessage = "An error occurred while creating the client. Please try again.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string? GetFieldError(string fieldName)
    {
        if (_editContext is null) return null;
        var messages = _editContext.GetValidationMessages(new FieldIdentifier(_model, fieldName));
        return messages.FirstOrDefault();
    }

    private class ClientFormModel
    {
        [Required(ErrorMessage = "First name is required.")]
        public string? FirstName { get; set; }

        [Required(ErrorMessage = "Last name is required.")]
        public string? LastName { get; set; }

        [EmailAddress(ErrorMessage = "Please enter a valid email address.")]
        public string? Email { get; set; }

        public string? Phone { get; set; }

        public string? DateOfBirth { get; set; }

        [Required(ErrorMessage = "A primary nutritionist is required.")]
        public string? PrimaryNutritionistId { get; set; }

        public bool ConsentGiven { get; set; }

        public ConsentSignatureMethod ConsentMethod { get; set; } = ConsentSignatureMethod.Digital;

        public string? Notes { get; set; }
    }
}
