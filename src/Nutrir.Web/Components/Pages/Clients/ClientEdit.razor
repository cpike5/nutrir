@page "/clients/{Id:int}/edit"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Nutrir.Core.DTOs
@using Nutrir.Core.Interfaces
@using Nutrir.Core.Models
@using Nutrir.Web.Components.UI
@attribute [Authorize(Roles = "Admin,Nutritionist,Assistant")]
@inject IClientService ClientService
@inject IConsentService ConsentService
@inject IConsentFormService ConsentFormService
@inject IConsentFormTemplate ConsentFormTemplate
@inject IUserManagementService UserManagementService
@inject NavigationManager NavigationManager

<PageTitle>Edit Client — Nutrir</PageTitle>

<Breadcrumb Items="@(new[] { new BreadcrumbItem("Clients", "/clients"), new BreadcrumbItem(_client?.FirstName + " " + _client?.LastName, $"/clients/{Id}"), new BreadcrumbItem("Edit") })" />

<div class="form-page">
    @if (_isLoading)
    {
        <p class="form-loading">Loading client...</p>
    }
    else if (_client is null)
    {
        <div class="table-card">
            <div class="not-found">
                <p class="not-found-title">Client not found</p>
                <p class="not-found-desc">The client you are trying to edit does not exist or has been removed.</p>
                <div class="not-found-action">
                    <Button Variant="ButtonVariant.Outline" OnClick="NavigateToList">Back to Clients</Button>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="page-header">
            <a href="/clients/@Id" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            </a>
            <div class="page-header-text">
                <h1 class="page-title">Edit Client</h1>
                <span class="page-subtitle">@_client.FirstName @_client.LastName</span>
            </div>
        </div>

        <div class="table-card">
            <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="EditClient">
                <DataAnnotationsValidator />

                <div class="section-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        <path d="M22 3.5 16.5 9 14 6.5"/>
                    </svg>
                    <span class="section-header-label">Client Details</span>
                </div>
                <div class="form-body">
                    <div class="form-grid">
                        <FormGroup Label="First Name" Id="firstName" Error="@GetFieldError(nameof(_model.FirstName))">
                            <FormInput Id="firstName"
                                       Value="@_model.FirstName"
                                       ValueChanged="@(v => _model.FirstName = v)"
                                       Placeholder="Enter first name" />
                        </FormGroup>

                        <FormGroup Label="Last Name" Id="lastName" Error="@GetFieldError(nameof(_model.LastName))">
                            <FormInput Id="lastName"
                                       Value="@_model.LastName"
                                       ValueChanged="@(v => _model.LastName = v)"
                                       Placeholder="Enter last name" />
                        </FormGroup>
                    </div>

                    <div class="form-grid">
                        <FormGroup Label="Email" Id="email">
                            <FormInput Id="email"
                                       Type="email"
                                       Value="@_model.Email"
                                       ValueChanged="@(v => _model.Email = v)"
                                       Placeholder="email@example.com" />
                        </FormGroup>

                        <FormGroup Label="Phone" Id="phone">
                            <FormInput Id="phone"
                                       Type="tel"
                                       Value="@_model.Phone"
                                       ValueChanged="OnPhoneChanged"
                                       Placeholder="(555) 123-4567" />
                        </FormGroup>
                    </div>

                    <div class="form-grid">
                        <FormGroup Label="Date of Birth" Id="dateOfBirth">
                            <FormInput Id="dateOfBirth"
                                       Type="date"
                                       Value="@_model.DateOfBirth"
                                       ValueChanged="@(v => _model.DateOfBirth = v)" />
                        </FormGroup>

                        <FormGroup Label="Primary Nutritionist" Id="nutritionist">
                            <Autocomplete Id="nutritionist"
                                          Options="@_nutritionistOptions"
                                          Value="@_model.PrimaryNutritionistId"
                                          ValueChanged="@(v => _model.PrimaryNutritionistId = v)"
                                          DisplayText="@_nutritionistDisplayText"
                                          DisplayTextChanged="@(v => _nutritionistDisplayText = v)"
                                          Placeholder="Search for a nutritionist..." />
                        </FormGroup>
                    </div>

                    <FormGroup Label="Notes" Id="notes">
                        <textarea id="notes"
                                  class="form-input"
                                  rows="4"
                                  @bind="_model.Notes"
                                  placeholder="Additional notes about the client..."></textarea>
                    </FormGroup>

                    <div class="consent-row">
                        <div class="consent-status">
                            @if (_client!.ConsentGiven)
                            {
                                <Badge Variant="BadgeVariant.Success"><span class="badge-dot"></span> Consent Given</Badge>
                                @if (_client.ConsentTimestamp.HasValue || !string.IsNullOrEmpty(_client.ConsentPolicyVersion))
                                {
                                    <span class="consent-meta">
                                        @if (_client.ConsentTimestamp.HasValue)
                                        {
                                            @_client.ConsentTimestamp.Value.ToString("MMM d, yyyy")
                                        }
                                        @if (!string.IsNullOrEmpty(_client.ConsentPolicyVersion))
                                        {
                                            <span> · Policy v@(_client.ConsentPolicyVersion)</span>
                                        }
                                    </span>
                                }
                                <Button Variant="ButtonVariant.Ghost" OnClick="WithdrawConsent" Disabled="@_isWithdrawing">
                                    @if (_isWithdrawing)
                                    {
                                        <span>Withdrawing...</span>
                                    }
                                    else
                                    {
                                        <span>Withdraw Consent</span>
                                    }
                                </Button>
                            }
                            else
                            {
                                <Badge Variant="BadgeVariant.Warning"><span class="badge-dot"></span> No Consent</Badge>
                                @if (_client.ConsentTimestamp.HasValue)
                                {
                                    <span class="consent-meta">Withdrawn @_client.ConsentTimestamp.Value.ToString("MMM d, yyyy")</span>
                                }
                            }
                        </div>
                    </div>

                    @if (!_client!.ConsentGiven)
                    {
                        <div class="consent-grant-section">
                            <div class="section-header">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                </svg>
                                <span class="section-header-label">Grant Consent</span>
                            </div>
                            <div class="consent-grant-body">
                                <p class="consent-grant-desc">Review the consent form below, then confirm that the client has provided their informed consent.</p>

                                <ConsentFormReview Content="@_consentContent" />

                                <div class="consent-grant-actions">
                                    <Button Variant="ButtonVariant.Primary" OnClick="GrantConsent" Disabled="@_isGranting">
                                        @if (_isGranting)
                                        {
                                            <span>Granting Consent...</span>
                                        }
                                        else
                                        {
                                            <span>Grant Consent</span>
                                        }
                                    </Button>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="error-banner">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                        @_errorMessage
                    </div>
                }

                <div class="form-actions">
                    <Button Variant="ButtonVariant.Primary" Type="submit" Disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Changes</span>
                        }
                    </Button>
                    <a href="/clients/@Id" class="cancel-link">Cancel</a>
                </div>
            </EditForm>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;

    private ClientDto? _client;
    private ClientFormModel _model = new();
    private EditContext? _editContext;
    private bool _isLoading = true;
    private bool _isSubmitting;
    private string? _errorMessage;
    private IReadOnlyList<Autocomplete.AutocompleteOption> _nutritionistOptions = [];
    private string? _nutritionistDisplayText;

    protected override async Task OnInitializedAsync()
    {
        _client = await ClientService.GetByIdAsync(Id);

        if (_client is not null)
        {
            _model = new ClientFormModel
            {
                FirstName = _client.FirstName,
                LastName = _client.LastName,
                Email = _client.Email,
                Phone = PhoneFormatter.Format(_client.Phone),
                DateOfBirth = _client.DateOfBirth?.ToString("yyyy-MM-dd"),
                PrimaryNutritionistId = _client.PrimaryNutritionistId,
                Notes = _client.Notes
            };
            _editContext = new EditContext(_model);

            var nutritionists = await UserManagementService.GetUsersAsync(
                roleFilter: "Nutritionist", isActiveFilter: true);

            _nutritionistOptions = nutritionists
                .Select(n => new Autocomplete.AutocompleteOption(n.Id, n.DisplayName))
                .ToList();

            // Pre-populate display text from loaded nutritionist list or from the client record
            var currentNutritionist = _nutritionistOptions.FirstOrDefault(
                o => o.Value == _client.PrimaryNutritionistId);
            _nutritionistDisplayText = currentNutritionist?.Text
                ?? _client.PrimaryNutritionistName;

            if (!_client.ConsentGiven)
            {
                var practitionerName = _nutritionistDisplayText ?? "(Practitioner)";
                _consentContent = ConsentFormTemplate.Generate(
                    $"{_client.FirstName} {_client.LastName}",
                    practitionerName,
                    DateTime.UtcNow);
            }
        }

        _isLoading = false;
    }

    private void OnPhoneChanged(string value)
    {
        _model.Phone = PhoneFormatter.Format(value);
    }

    private bool _isWithdrawing;
    private bool _isGranting;
    private ConsentFormContent? _consentContent;

    private async Task GrantConsent()
    {
        _isGranting = true;
        _errorMessage = null;

        try
        {
            var authState = await AuthState;
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                _errorMessage = "Unable to identify the current user. Please sign out and back in.";
                return;
            }

            // Regenerate consent content with current timestamp for accuracy
            var practitionerName = _nutritionistDisplayText ?? "(Practitioner)";
            _consentContent = ConsentFormTemplate.Generate(
                $"{_client!.FirstName} {_client.LastName}",
                practitionerName,
                DateTime.UtcNow);

            await ConsentFormService.RecordDigitalSignatureAsync(Id, userId);

            // Reload client to reflect updated consent status
            _client = await ClientService.GetByIdAsync(Id);
            if (_client is null)
            {
                _errorMessage = "Client could not be reloaded. Please refresh the page.";
            }
        }
        catch
        {
            _errorMessage = "An error occurred while granting consent. Please try again.";
        }
        finally
        {
            _isGranting = false;
        }
    }

    private async Task WithdrawConsent()
    {
        _isWithdrawing = true;
        _errorMessage = null;

        try
        {
            var authState = await AuthState;
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

            await ConsentService.WithdrawConsentAsync(Id, userId);

            // Reload client to reflect updated consent status
            _client = await ClientService.GetByIdAsync(Id);
        }
        catch
        {
            _errorMessage = "An error occurred while withdrawing consent. Please try again.";
        }
        finally
        {
            _isWithdrawing = false;
        }
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            var authState = await AuthState;
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

            DateOnly? dob = null;
            if (!string.IsNullOrEmpty(_model.DateOfBirth) && DateOnly.TryParse(_model.DateOfBirth, out var parsedDob))
            {
                dob = parsedDob;
            }

            // Consent fields are immutable — managed via IConsentService only
            var dto = new ClientDto(
                Id: Id,
                FirstName: _model.FirstName!,
                LastName: _model.LastName!,
                Email: string.IsNullOrWhiteSpace(_model.Email) ? null : _model.Email,
                Phone: string.IsNullOrWhiteSpace(_model.Phone) ? null : PhoneFormatter.ToDigits(_model.Phone),
                DateOfBirth: dob,
                PrimaryNutritionistId: _model.PrimaryNutritionistId ?? string.Empty,
                PrimaryNutritionistName: null,
                ConsentGiven: _client!.ConsentGiven,
                ConsentTimestamp: _client.ConsentTimestamp,
                ConsentPolicyVersion: _client.ConsentPolicyVersion,
                Notes: string.IsNullOrWhiteSpace(_model.Notes) ? null : _model.Notes,
                IsDeleted: _client.IsDeleted,
                CreatedAt: _client.CreatedAt,
                UpdatedAt: DateTime.UtcNow,
                DeletedAt: _client.DeletedAt
            );

            var success = await ClientService.UpdateAsync(Id, dto, userId);
            if (success)
            {
                NavigationManager.NavigateTo($"/clients/{Id}");
            }
            else
            {
                _errorMessage = "Failed to save changes. Please try again.";
            }
        }
        catch
        {
            _errorMessage = "An error occurred while saving the client. Please try again.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void NavigateToList()
    {
        NavigationManager.NavigateTo("/clients");
    }

    private string? GetFieldError(string fieldName)
    {
        if (_editContext is null) return null;
        var messages = _editContext.GetValidationMessages(new FieldIdentifier(_model, fieldName));
        return messages.FirstOrDefault();
    }

    private class ClientFormModel
    {
        [Required(ErrorMessage = "First name is required.")]
        public string? FirstName { get; set; }

        [Required(ErrorMessage = "Last name is required.")]
        public string? LastName { get; set; }

        [EmailAddress(ErrorMessage = "Please enter a valid email address.")]
        public string? Email { get; set; }

        public string? Phone { get; set; }

        public string? DateOfBirth { get; set; }

        public string? PrimaryNutritionistId { get; set; }

        public string? Notes { get; set; }
    }
}
