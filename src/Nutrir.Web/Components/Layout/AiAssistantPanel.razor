@rendermode InteractiveServer
@implements IAsyncDisposable
@implements IDisposable
@inject IAiAgentService AiAgent
@inject AiPanelState PanelState
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@using Nutrir.Core.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

<div class="cc-ai-panel @(_isOpen ? "cc-ai-panel--open" : "") @(_isWide ? "cc-ai-panel--wide" : "")">
    <div class="cc-ai-header">
        <div class="cc-ai-header-left">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a8 8 0 0 0-8 8c0 3.4 2.1 6.3 5 7.5V20h6v-2.5c2.9-1.2 5-4.1 5-7.5a8 8 0 0 0-8-8z"/>
                <line x1="10" y1="22" x2="14" y2="22"/>
            </svg>
            <span>Nutrir Assistant</span>
        </div>
        <div class="cc-ai-header-right">
            @if (_messages.Count > 0)
            {
                <button class="cc-ai-header-btn" title="Clear conversation" @onclick="ClearConversation">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            }
            <button class="cc-ai-header-btn cc-ai-wide-toggle @(_isWide ? "cc-ai-wide-toggle--active" : "")" title="@(_isWide ? "Narrow panel" : "Widen panel")" @onclick="ToggleWide">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    @if (_isWide)
                    {
                        <polyline points="15 3 9 3"/><polyline points="15 21 9 21"/>
                        <line x1="20" y1="12" x2="15" y2="8"/><line x1="20" y1="12" x2="15" y2="16"/>
                        <line x1="4" y1="12" x2="9" y2="8"/><line x1="4" y1="12" x2="9" y2="16"/>
                        <line x1="4" y1="12" x2="20" y2="12"/>
                    }
                    else
                    {
                        <polyline points="4 3 9 3"/><polyline points="4 21 9 21"/>
                        <line x1="4" y1="12" x2="9" y2="8"/><line x1="4" y1="12" x2="9" y2="16"/>
                        <line x1="20" y1="12" x2="15" y2="8"/><line x1="20" y1="12" x2="15" y2="16"/>
                        <line x1="4" y1="12" x2="20" y2="12"/>
                    }
                </svg>
            </button>
            <button class="cc-ai-header-btn" title="Close panel" @onclick="Close">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="cc-ai-messages" id="ai-messages-container">
        @if (_messages.Count == 0 && !_isStreaming)
        {
            <div class="cc-ai-welcome">
                <div class="cc-ai-welcome-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a8 8 0 0 0-8 8c0 3.4 2.1 6.3 5 7.5V20h6v-2.5c2.9-1.2 5-4.1 5-7.5a8 8 0 0 0-8-8z"/>
                        <line x1="10" y1="22" x2="14" y2="22"/>
                    </svg>
                </div>
                <p class="cc-ai-welcome-text">Ask me anything about your practice data, or tell me to make changes.</p>
                <div class="cc-ai-starters">
                    @foreach (var starter in _starters)
                    {
                        <button class="cc-ai-starter" @onclick="() => SendStarter(starter)">@starter</button>
                    }
                </div>
            </div>
        }
        else
        {
            @foreach (var msg in _messages)
            {
                <div class="cc-ai-msg cc-ai-msg--@msg.Role">
                    <div class="cc-ai-msg-content">
                        @if (msg.Role == "user")
                        {
                            @msg.Text
                        }
                        else
                        {
                            @((MarkupString)RenderMarkdown(msg.Text))
                            @foreach (var confirmation in msg.Confirmations)
                            {
                                var isElevated = confirmation.Request.Tier == ConfirmationTier.Elevated;
                                <div class="cc-ai-confirmation @(isElevated ? "cc-ai-confirmation--elevated" : "")">
                                    @if (confirmation.Result is null)
                                    {
                                        <p class="cc-ai-confirmation-desc">
                                            @if (isElevated)
                                            {
                                                <svg class="cc-ai-confirmation-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                                    <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                                                </svg>
                                            }
                                            The assistant wants to <strong>@confirmation.Request.Description</strong>
                                        </p>
                                        <div class="cc-ai-confirmation-actions">
                                            <button class="cc-ai-btn-allow" @onclick="() => HandleConfirmation(confirmation, true)">Allow</button>
                                            <button class="cc-ai-btn-deny" @onclick="() => HandleConfirmation(confirmation, false)">Deny</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="cc-ai-confirmation-resolved">
                                            @(confirmation.Result == true ? "Allowed" : "Denied"): <strong>@confirmation.Request.Description</strong>
                                        </p>
                                    }
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(msg.ToolStatus))
                            {
                                <div class="cc-ai-tool-status">
                                    <span class="cc-ai-tool-spinner"></span>
                                    @msg.ToolStatus
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        }
    </div>

    <div class="cc-ai-input-area">
        <div class="cc-ai-input-row">
            <input id="ai-input"
                   type="text"
                   placeholder="Ask about clients, appointments, meal plans..."
                   autocomplete="off"
                   @bind="_inputText"
                   @bind:event="oninput"
                   @onkeydown="HandleKeyDown"
                   disabled="@_isStreaming" />
            <button class="cc-ai-send-btn" @onclick="SendMessage" disabled="@(_isStreaming || string.IsNullOrWhiteSpace(_inputText))">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
    </div>
</div>

@code {
    private bool _isOpen;
    private bool _isWide;
    private bool _isStreaming;
    private string _inputText = "";
    private readonly List<ChatMessage> _messages = [];
    private bool _jsInitialized;
    private bool _userContextSet;
    private bool _historyLoaded;
    private CancellationTokenSource? _streamCts;
    private bool _justCompletedTool;

    private static readonly string[] _starters =
    [
        "What appointments are today?",
        "Give me a practice overview",
        "Create a new client",
        "Schedule an appointment",
        "Search for a client by name",
        "List draft meal plans needing review",
        "Create a goal for a client",
        "Log a progress entry",
    ];

    protected override void OnInitialized()
    {
        PanelState.OnToggle += OnPanelToggle;
        Navigation.LocationChanged += OnLocationChanged;
        _isOpen = PanelState.IsOpen;
        UpdatePageContext(Navigation.Uri);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _jsInitialized = true;

            try
            {
                _isWide = await JS.InvokeAsync<bool>("aiPanel.getStoredWideState");

                var storedOpen = await JS.InvokeAsync<bool>("aiPanel.getStoredState");
                if (storedOpen)
                {
                    _isOpen = true;
                    PanelState.SetOpen(true);
                }
            }
            catch (JSException) { }

            if (!_userContextSet)
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                var firstName = user.FindFirst("FirstName")?.Value;
                var lastName = user.FindFirst("LastName")?.Value;
                var name = firstName is not null && lastName is not null
                    ? $"{firstName} {lastName}"
                    : user.Identity?.Name?.Split('@')[0] ?? "User";
                var role = user.FindFirst(ClaimTypes.Role)?.Value ?? "User";
                AiAgent.SetUserContext(name, role);

                var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (userId is not null)
                    AiAgent.SetUserId(userId);

                _userContextSet = true;
            }

            if (!_historyLoaded)
            {
                _historyLoaded = true;
                try
                {
                    var displayMessages = await AiAgent.LoadHistoryAsync();
                    if (displayMessages is { Count: > 0 })
                    {
                        foreach (var dm in displayMessages)
                        {
                            _messages.Add(new ChatMessage
                            {
                                Role = dm.Role,
                                Text = dm.Text ?? ""
                            });
                        }
                        StateHasChanged();
                    }
                }
                catch { /* Don't block panel if history load fails */ }
            }
        }

        if (_isOpen && _messages.Count > 0)
        {
            try { await JS.InvokeVoidAsync("aiPanel.scrollToBottom", "ai-messages-container"); }
            catch (JSException) { }
        }
    }

    private void OnPanelToggle()
    {
        _isOpen = PanelState.IsOpen;
        InvokeAsync(async () =>
        {
            StateHasChanged();
            if (_jsInitialized)
            {
                try
                {
                    await JS.InvokeVoidAsync("aiPanel.saveState", _isOpen);
                    if (_isOpen)
                        await JS.InvokeVoidAsync("aiPanel.focusInput", "ai-input");
                }
                catch (JSException) { }
            }
        });
    }

    private void Close()
    {
        _streamCts?.Cancel();
        PanelState.Close();
    }

    private async Task ToggleWide()
    {
        _isWide = !_isWide;
        if (_jsInitialized)
        {
            try { await JS.InvokeVoidAsync("aiPanel.saveWideState", _isWide); }
            catch (JSException) { }
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !_isStreaming && !string.IsNullOrWhiteSpace(_inputText))
        {
            await SendMessage();
        }
    }

    private Task SendStarter(string text)
    {
        _inputText = text;
        return SendMessage();
    }

    private async Task SendMessage()
    {
        if (_isStreaming || string.IsNullOrWhiteSpace(_inputText))
            return;

        var userText = _inputText.Trim();
        _inputText = "";
        _isStreaming = true;
        _justCompletedTool = false;
        _streamCts = new CancellationTokenSource();

        _messages.Add(new ChatMessage { Role = "user", Text = userText });
        var assistantMsg = new ChatMessage { Role = "assistant", Text = "" };
        _messages.Add(assistantMsg);
        StateHasChanged();

        try
        {
            await foreach (var evt in AiAgent.SendMessageAsync(userText, _streamCts.Token))
            {
                if (evt.ConfirmationRequest is not null)
                {
                    assistantMsg.Confirmations.Add(new ConfirmationRecord
                    {
                        Request = evt.ConfirmationRequest
                    });
                    assistantMsg.ToolStatus = null;
                    StateHasChanged();
                    // Stream naturally pauses here waiting for user response
                    continue;
                }

                if (evt.TextDelta is not null)
                {
                    if (_justCompletedTool && !string.IsNullOrEmpty(assistantMsg.Text))
                    {
                        assistantMsg.Text += "\n\n";
                    }
                    assistantMsg.Text += evt.TextDelta;
                    assistantMsg.ToolStatus = null;
                    _justCompletedTool = false;
                }
                else if (evt.ToolName is not null)
                {
                    assistantMsg.ToolStatus = $"Looking up {FormatToolName(evt.ToolName)}...";
                    _justCompletedTool = true;
                }
                else if (evt.IsComplete)
                {
                    assistantMsg.ToolStatus = null;
                }
                else if (evt.Error is not null)
                {
                    assistantMsg.Text += string.IsNullOrEmpty(assistantMsg.Text)
                        ? evt.Error
                        : $"\n\n{evt.Error}";
                    assistantMsg.ToolStatus = null;
                }

                StateHasChanged();
            }
        }
        catch (OperationCanceledException)
        {
            // Stream was cancelled (panel closed or conversation cleared) — no error to show
        }
        catch (Exception)
        {
            if (string.IsNullOrEmpty(assistantMsg.Text))
                assistantMsg.Text = "Sorry, something went wrong. Please try again.";
        }
        finally
        {
            _streamCts?.Dispose();
            _streamCts = null;
            _isStreaming = false;
            assistantMsg.ToolStatus = null;
            StateHasChanged();
            try { await JS.InvokeVoidAsync("aiPanel.focusInput", "ai-input"); }
            catch (JSException) { }
        }
    }

    private void HandleConfirmation(ConfirmationRecord confirmation, bool allowed)
    {
        if (confirmation.Result is not null)
            return;

        confirmation.Result = allowed;
        AiAgent.RespondToConfirmation(confirmation.Request.ToolCallId, allowed);
        StateHasChanged();
    }

    private async Task ClearConversation()
    {
        _streamCts?.Cancel();
        _messages.Clear();
        await AiAgent.ClearHistoryAsync();
        StateHasChanged();
    }

    private static string FormatToolName(string toolName) => toolName switch
    {
        "list_clients" => "clients",
        "get_client" => "client details",
        "create_client" => "creating client",
        "update_client" => "updating client",
        "delete_client" => "deleting client",
        "list_appointments" => "appointments",
        "get_appointment" => "appointment details",
        "create_appointment" => "creating appointment",
        "update_appointment" => "updating appointment",
        "cancel_appointment" => "cancelling appointment",
        "delete_appointment" => "deleting appointment",
        "list_meal_plans" => "meal plans",
        "get_meal_plan" => "meal plan details",
        "create_meal_plan" => "creating meal plan",
        "update_meal_plan" => "updating meal plan",
        "activate_meal_plan" => "activating meal plan",
        "archive_meal_plan" => "archiving meal plan",
        "duplicate_meal_plan" => "duplicating meal plan",
        "delete_meal_plan" => "deleting meal plan",
        "list_goals" => "goals",
        "get_goal" => "goal details",
        "create_goal" => "creating goal",
        "update_goal" => "updating goal",
        "achieve_goal" => "achieving goal",
        "abandon_goal" => "abandoning goal",
        "delete_goal" => "deleting goal",
        "list_progress" => "progress entries",
        "get_progress_entry" => "progress details",
        "create_progress_entry" => "creating progress entry",
        "delete_progress_entry" => "deleting progress entry",
        "list_users" => "users",
        "get_user" => "user details",
        "create_user" => "creating user",
        "change_user_role" => "changing user role",
        "deactivate_user" => "deactivating user",
        "reactivate_user" => "reactivating user",
        "reset_user_password" => "resetting password",
        "search" => "search results",
        "get_dashboard" => "dashboard data",
        _ => toolName.Replace('_', ' ')
    };

    /// <summary>
    /// Minimal markdown rendering: bold, italic, code, headers, line breaks, lists, tables.
    /// </summary>
    private static string RenderMarkdown(string text)
    {
        if (string.IsNullOrEmpty(text)) return "";

        var escaped = System.Net.WebUtility.HtmlEncode(text);

        // Entity link chips: [[type:id:display]]
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"\[\[(\w+):(\d+|[\w-]+):(.+?)\]\]",
            match =>
            {
                var entityType = match.Groups[1].Value;
                var id = match.Groups[2].Value;
                var display = match.Groups[3].Value;
                var href = entityType switch
                {
                    "client" => $"/clients/{id}",
                    "appointment" => $"/appointments/{id}",
                    "meal_plan" => $"/meal-plans/{id}",
                    "user" => $"/admin/users/{id}",
                    _ => (string?)null
                };
                return href is not null
                    ? $"<a href=\"{href}\" class=\"cc-ai-entity-chip\">{display}</a>"
                    : display;
            });

        // Code blocks (```)
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"```(\w*)\r?\n([\s\S]*?)```",
            "<pre><code>$2</code></pre>");

        // Inline code
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"`([^`]+)`",
            "<code>$1</code>");

        // Bold
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"\*\*(.+?)\*\*",
            "<strong>$1</strong>");

        // Italic
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"\*(.+?)\*",
            "<em>$1</em>");

        // Headers — render with distinct hierarchy classes
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"^### (.+)$",
            "<div class=\"cc-ai-h3\">$1</div>",
            System.Text.RegularExpressions.RegexOptions.Multiline);
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"^## (.+)$",
            "<div class=\"cc-ai-h2\">$1</div>",
            System.Text.RegularExpressions.RegexOptions.Multiline);
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"^# (.+)$",
            "<div class=\"cc-ai-h1\">$1</div>",
            System.Text.RegularExpressions.RegexOptions.Multiline);

        // Blockquotes
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"^&gt; (.+)$",
            "<div class=\"cc-ai-blockquote\">$1</div>",
            System.Text.RegularExpressions.RegexOptions.Multiline);

        // Horizontal rules
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"^---+$",
            "<hr/>",
            System.Text.RegularExpressions.RegexOptions.Multiline);

        // Tables: convert markdown tables to HTML
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"(\|.+\|\r?\n\|[-| :]+\|\r?\n(?:\|.+\|\r?\n?)+)",
            match => ConvertTable(match.Value),
            System.Text.RegularExpressions.RegexOptions.Multiline);

        // Unordered list items — use data attribute marker for grouping
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"^[-*] (.+)$",
            "<li data-ul>$1</li>",
            System.Text.RegularExpressions.RegexOptions.Multiline);

        // Ordered list items — use data attribute marker for grouping
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"^\d+\. (.+)$",
            "<li data-ol>$1</li>",
            System.Text.RegularExpressions.RegexOptions.Multiline);

        // Wrap consecutive <li data-ul> in <ul> and <li data-ol> in <ol>
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"(<li data-ul>[\s\S]*?</li>)(?=\s*(?!<li data-ul>))",
            match => "<ul>" + match.Value + "</ul>");
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"(<li data-ol>[\s\S]*?</li>)(?=\s*(?!<li data-ol>))",
            match => "<ol>" + match.Value + "</ol>");

        // Clean up the data markers
        escaped = escaped.Replace(" data-ul", "").Replace(" data-ol", "");

        // Line breaks (double newline = paragraph break)
        escaped = escaped.Replace("\r\n", "\n");
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"\n\n",
            "<br/><br/>");
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"\n",
            "<br/>");

        // Clean up excessive <br/> around block elements
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"(<br/>)+\s*(<(?:div|table|ul|ol|hr|pre)[ >])",
            "$2");
        escaped = System.Text.RegularExpressions.Regex.Replace(escaped,
            @"(</(?:div|table|ul|ol|hr|pre)>)\s*(<br/>)+",
            "$1");

        return escaped;
    }

    private static readonly HashSet<string> StatusSuccess = new(StringComparer.OrdinalIgnoreCase)
        { "Confirmed", "Active", "Completed" };
    private static readonly HashSet<string> StatusWarning = new(StringComparer.OrdinalIgnoreCase)
        { "Scheduled", "Pending", "Draft" };
    private static readonly HashSet<string> StatusError = new(StringComparer.OrdinalIgnoreCase)
        { "Cancelled", "No-show", "Expired" };

    private static string ApplyStatusBadge(string cell)
    {
        var trimmed = cell.Trim();
        if (StatusSuccess.Contains(trimmed))
            return $"<span class=\"cc-ai-status-success\">{cell}</span>";
        if (StatusWarning.Contains(trimmed))
            return $"<span class=\"cc-ai-status-warning\">{cell}</span>";
        if (StatusError.Contains(trimmed))
            return $"<span class=\"cc-ai-status-error\">{cell}</span>";
        return cell;
    }

    private static string ConvertTable(string markdown)
    {
        var lines = markdown.Trim().Split('\n')
            .Select(l => l.Trim().Trim('|'))
            .ToArray();

        if (lines.Length < 2) return markdown;

        var sb = new System.Text.StringBuilder();
        sb.Append("<div class=\"cc-ai-table-wrap\"><table class=\"cc-ai-table\">");

        // Header
        var headers = lines[0].Split('|').Select(h => h.Trim()).ToArray();
        sb.Append("<thead><tr>");
        foreach (var h in headers)
            sb.Append($"<th>{h}</th>");
        sb.Append("</tr></thead>");

        // Body (skip separator line at index 1)
        sb.Append("<tbody>");
        for (int i = 2; i < lines.Length; i++)
        {
            var cells = lines[i].Split('|').Select(c => c.Trim()).ToArray();
            sb.Append("<tr>");
            foreach (var c in cells)
                sb.Append($"<td>{ApplyStatusBadge(c)}</td>");
            sb.Append("</tr>");
        }
        sb.Append("</tbody></table></div>");

        return sb.ToString();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdatePageContext(e.Location);
    }

    private void UpdatePageContext(string uri)
    {
        var (entityType, entityId) = ParsePageContext(uri);
        AiAgent.SetPageContext(entityType, entityId);
    }

    private static (string? entityType, string? entityId) ParsePageContext(string uri)
    {
        // Extract the path portion from the URI
        var path = new Uri(uri, UriKind.RelativeOrAbsolute).IsAbsoluteUri
            ? new Uri(uri).AbsolutePath
            : uri;

        var match = System.Text.RegularExpressions.Regex.Match(path, @"^/clients/(\d+)");
        if (match.Success) return ("client", match.Groups[1].Value);

        match = System.Text.RegularExpressions.Regex.Match(path, @"^/appointments/(\d+)");
        if (match.Success) return ("appointment", match.Groups[1].Value);

        match = System.Text.RegularExpressions.Regex.Match(path, @"^/meal-plans/(\d+)");
        if (match.Success) return ("meal_plan", match.Groups[1].Value);

        match = System.Text.RegularExpressions.Regex.Match(path, @"^/admin/users/([\w-]+)");
        if (match.Success) return ("user", match.Groups[1].Value);

        return (null, null);
    }

    private class ConfirmationRecord
    {
        public ToolConfirmationRequest Request { get; init; } = default!;
        public bool? Result { get; set; }
    }

    private class ChatMessage
    {
        public string Role { get; init; } = "";
        public string Text { get; set; } = "";
        public string? ToolStatus { get; set; }
        public List<ConfirmationRecord> Confirmations { get; } = [];

        /// <summary>
        /// Returns the active (unresolved) confirmation, if any.
        /// </summary>
        public ConfirmationRecord? ActiveConfirmation =>
            Confirmations.LastOrDefault(c => c.Result is null);
    }

    public void Dispose()
    {
        PanelState.OnToggle -= OnPanelToggle;
        Navigation.LocationChanged -= OnLocationChanged;
        _streamCts?.Cancel();
        _streamCts?.Dispose();
    }

    public ValueTask DisposeAsync()
    {
        PanelState.OnToggle -= OnPanelToggle;
        Navigation.LocationChanged -= OnLocationChanged;
        _streamCts?.Cancel();
        _streamCts?.Dispose();
        return ValueTask.CompletedTask;
    }
}
