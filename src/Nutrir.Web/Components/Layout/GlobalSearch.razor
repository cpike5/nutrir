@rendermode InteractiveServer
@implements IAsyncDisposable
@implements IDisposable
@inject ISearchService SearchService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@using Nutrir.Core.DTOs
@using Nutrir.Core.Interfaces
@using Microsoft.AspNetCore.Components.Authorization

<div class="cc-search" @onkeydown="HandleKeyDown" @onkeydown:preventDefault="_preventKeyDefault">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    <input id="@_inputId"
           type="text"
           placeholder="Search..."
           role="combobox"
           autocomplete="off"
           aria-expanded="@(_isOpen ? "true" : "false")"
           aria-controls="search-dropdown"
           aria-activedescendant="@(_highlightedIndex >= 0 ? $"search-result-{_highlightedIndex}" : null)"
           @bind="_query"
           @bind:event="oninput"
           @bind:after="OnQueryChanged"
           @onfocus="OnInputFocus"
           @onfocusout="OnInputFocusOut" />
    @if (!_isFocused)
    {
        <span class="search-hint">
            <kbd class="cc-kbd">Ctrl</kbd>
            <kbd class="cc-kbd">K</kbd>
        </span>
    }

    @if (_isOpen)
    {
        <div class="search-backdrop" @onclick="CloseDropdown"></div>
        <div id="search-dropdown" class="search-dropdown" role="listbox" aria-label="Search results">
            <div aria-live="polite" class="visually-hidden">
                @if (_results is not null)
                {
                    @($"{_results.TotalCount} results found")
                }
            </div>

            @if (_isLoading)
            {
                @* Skeleton loading state *@
                <div class="search-section">
                    <div class="search-section-header" style="border-top: none;">
                        <span class="search-section-label"><span class="cc-skeleton" style="width: 60px; height: 12px; display: inline-block;"></span></span>
                    </div>
                    @for (var i = 0; i < 3; i++)
                    {
                        <div class="search-result-row">
                            <div class="search-result-icon cc-skeleton" style="width: 28px; height: 28px; border-radius: 50%;"></div>
                            <div class="search-result-content">
                                <div class="cc-skeleton" style="width: @(100 + Random.Shared.Next(60))px; height: 14px; margin-bottom: 4px;"></div>
                                <div class="cc-skeleton" style="width: @(80 + Random.Shared.Next(40))px; height: 11px;"></div>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (_error is not null)
            {
                <div class="search-empty" style="color: var(--color-error);">
                    Could not load results. Try again.
                </div>
            }
            else if (string.IsNullOrEmpty(_query) || _query.Trim().Length < 2)
            {
                @* Recent searches *@
                @if (_recentSearches.Count > 0)
                {
                    <div class="search-section">
                        <div class="search-section-header" style="border-top: none;">
                            <span class="search-section-label">Recent</span>
                            <button class="search-recent-clear" @onclick="ClearRecentSearches">Clear history</button>
                        </div>
                        @foreach (var recent in _recentSearches.Take(5))
                        {
                            <a class="search-result-row" href="@recent.Url" @onclick="() => NavigateTo(recent.Url)" @onclick:preventDefault>
                                <div class="search-result-icon search-result-icon--recent">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                </div>
                                <div class="search-result-content">
                                    <span class="search-result-primary">@recent.Label</span>
                                </div>
                                <div class="search-result-meta">
                                    <span class="search-result-type">@recent.Type</span>
                                    <svg class="search-result-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                                </div>
                            </a>
                        }
                    </div>
                }
            }
            else if (_results is not null && _results.TotalCount == 0)
            {
                <div class="search-empty">
                    <div class="search-empty-primary">No results for "@_query"</div>
                    <div class="search-empty-secondary">Try a name, appointment type, or meal plan title.</div>
                </div>
            }
            else if (_results is not null)
            {
                var flatIndex = 0;
                foreach (var group in _results.Groups)
                {
                    <div class="search-section" role="group" aria-label="@group.EntityType">
                        <div class="search-section-header @(group == _results.Groups[0] ? "search-section-header--first" : "")">
                            <span class="search-section-label">@group.EntityType</span>
                            <span class="search-section-count">@group.Items.Count of @group.TotalInGroup</span>
                        </div>
                        @foreach (var item in group.Items)
                        {
                            var idx = flatIndex;
                            <a id="search-result-@idx"
                               class="search-result-row @(idx == _highlightedIndex ? "search-result-row--focused" : "")"
                               role="option"
                               aria-selected="@(idx == _highlightedIndex ? "true" : "false")"
                               href="@item.Url"
                               @onclick="() => SelectResult(item)"
                               @onclick:preventDefault>
                                <div class="search-result-icon search-result-icon--@group.EntityType.ToLower().Replace(" ", "")">
                                    @if (group.EntityType == "Clients")
                                    {
                                        <span class="search-result-initials">@item.Initials</span>
                                    }
                                    else if (group.EntityType == "Appointments")
                                    {
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                                        </svg>
                                    }
                                </div>
                                <div class="search-result-content">
                                    <span class="search-result-primary">@item.PrimaryText</span>
                                    @if (!string.IsNullOrEmpty(item.SecondaryText))
                                    {
                                        <span class="search-result-secondary">@item.SecondaryText</span>
                                    }
                                </div>
                                <div class="search-result-meta">
                                    @if (!string.IsNullOrEmpty(item.StatusLabel))
                                    {
                                        <span class="badge badge-@item.StatusVariant">@item.StatusLabel</span>
                                    }
                                    <svg class="search-result-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                                </div>
                            </a>
                            flatIndex++;
                        }
                        @if (group.TotalInGroup > group.Items.Count)
                        {
                            var seeAllUrl = GetSeeAllUrl(group.EntityType);
                            <div class="search-section-footer">
                                <a href="@seeAllUrl" @onclick="() => NavigateTo(seeAllUrl)" @onclick:preventDefault>
                                    See all @group.TotalInGroup @group.EntityType.ToLower()
                                </a>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private string _inputId = $"global-search-{Guid.NewGuid():N}";
    private string _query = "";
    private bool _isOpen;
    private bool _isFocused;
    private bool _isLoading;
    private bool _preventKeyDefault;
    private int _highlightedIndex = -1;
    private SearchResultDto? _results;
    private string? _error;
    private List<RecentSearch> _recentSearches = [];
    private CancellationTokenSource? _debounceCts;
    private string? _userId;
    private bool _jsInitialized;

    private record RecentSearch(string Label, string Url, string Type, long Timestamp);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            try
            {
                await JS.InvokeVoidAsync("globalSearch.init", DotNetObjectReference.Create(this));
                _jsInitialized = true;
                await LoadRecentSearches();
                StateHasChanged();
            }
            catch (JSException) { }
        }
    }

    [JSInvokable]
    public async Task OnSearchShortcut()
    {
        _isOpen = true;
        _isFocused = true;
        StateHasChanged();
        await Task.Delay(50);
        try { await JS.InvokeVoidAsync("globalSearch.focusInput", _inputId); }
        catch (JSException) { }
    }

    private void OnInputFocus()
    {
        _isFocused = true;
        _isOpen = true;
    }

    private async Task OnInputFocusOut()
    {
        // Delay to allow click events on dropdown items to register
        await Task.Delay(200);
        if (!_isOpen) _isFocused = false;
    }

    private async Task OnQueryChanged()
    {
        _highlightedIndex = -1;

        if (string.IsNullOrWhiteSpace(_query) || _query.Trim().Length < 2)
        {
            _results = null;
            _isLoading = false;
            _error = null;
            return;
        }

        // Cancel previous debounce
        _debounceCts?.Cancel();
        _debounceCts = new CancellationTokenSource();
        var token = _debounceCts.Token;

        _isLoading = true;
        StateHasChanged();

        try
        {
            await Task.Delay(250, token);
            if (token.IsCancellationRequested) return;

            _results = await SearchService.SearchAsync(_query, _userId ?? "");
            _error = null;
        }
        catch (OperationCanceledException) { return; }
        catch (Exception)
        {
            _error = "Could not load results.";
            _results = null;
        }
        finally
        {
            if (!token.IsCancellationRequested)
                _isLoading = false;
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        _preventKeyDefault = false;

        if (e.Key == "Escape")
        {
            _preventKeyDefault = true;
            if (!string.IsNullOrEmpty(_query))
            {
                _query = "";
                _results = null;
                _highlightedIndex = -1;
            }
            else
            {
                CloseDropdown();
            }
        }
        else if (e.Key == "ArrowDown")
        {
            _preventKeyDefault = true;
            var totalItems = GetTotalItems();
            if (totalItems > 0)
                _highlightedIndex = (_highlightedIndex + 1) % totalItems;
        }
        else if (e.Key == "ArrowUp")
        {
            _preventKeyDefault = true;
            var totalItems = GetTotalItems();
            if (totalItems > 0)
                _highlightedIndex = _highlightedIndex <= 0 ? totalItems - 1 : _highlightedIndex - 1;
        }
        else if (e.Key == "Enter")
        {
            _preventKeyDefault = true;
            var item = GetItemAtIndex(_highlightedIndex);
            if (item is not null)
                _ = SelectResult(item);
        }
    }

    private int GetTotalItems()
    {
        if (_results is null) return 0;
        return _results.Groups.Sum(g => g.Items.Count);
    }

    private SearchResultItem? GetItemAtIndex(int index)
    {
        if (_results is null || index < 0) return null;
        var current = 0;
        foreach (var group in _results.Groups)
        {
            if (index < current + group.Items.Count)
                return group.Items[index - current];
            current += group.Items.Count;
        }
        return null;
    }

    private async Task SelectResult(SearchResultItem item)
    {
        // Add to recent searches
        var entityType = _results?.Groups.FirstOrDefault(g => g.Items.Contains(item))?.EntityType ?? "client";
        try
        {
            await JS.InvokeVoidAsync("globalSearch.addRecentSearch", new
            {
                label = item.PrimaryText,
                url = item.Url,
                type = entityType.ToLower().TrimEnd('s'),
                timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
            });
        }
        catch (JSException) { }

        CloseDropdown();
        NavigationManager.NavigateTo(item.Url);
    }

    private void NavigateTo(string url)
    {
        CloseDropdown();
        NavigationManager.NavigateTo(url);
    }

    private void CloseDropdown()
    {
        _isOpen = false;
        _isFocused = false;
        _highlightedIndex = -1;
    }

    private async Task ClearRecentSearches()
    {
        try
        {
            await JS.InvokeVoidAsync("globalSearch.clearRecentSearches");
            _recentSearches.Clear();
        }
        catch (JSException) { }
    }

    private async Task LoadRecentSearches()
    {
        try
        {
            _recentSearches = await JS.InvokeAsync<List<RecentSearch>>("globalSearch.getRecentSearches") ?? [];
        }
        catch (JSException) { _recentSearches = []; }
    }

    private string GetSeeAllUrl(string entityType) => entityType switch
    {
        "Clients" => $"/clients?q={Uri.EscapeDataString(_query)}",
        "Appointments" => $"/appointments?q={Uri.EscapeDataString(_query)}",
        "Meal Plans" => $"/meal-plans?q={Uri.EscapeDataString(_query)}",
        _ => "/"
    };

    public void Dispose()
    {
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
    }

    public async ValueTask DisposeAsync()
    {
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();

        if (_jsInitialized)
        {
            try { await JS.InvokeVoidAsync("globalSearch.dispose"); }
            catch (JSException) { }
        }
    }
}
